<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style> 
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; visibility: hidden; }
        .btn-glossy {
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            color: white;
            text-shadow: 0 -1px 1px rgba(0,0,0,0.3);
            border: 1px solid rgba(0,0,0,0.4);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.4),
                0 4px 6px -1px rgba(0,0,0,0.3), 
                0 2px 4px -2px rgba(0,0,0,0.3);
            transition: all 0.15s ease-out;
            transform: translateZ(0); /* For GPU acceleration */
            overflow: hidden;
        }
        .btn-glossy::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 5%;
            width: 90%;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.6), rgba(255,255,255,0.1));
            border-radius: 9999px;
            opacity: 0.8;
        }
        .btn-glossy:active {
            transform: translateY(2px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        .btn-glossy.purple { background: linear-gradient(to bottom, #a855f7, #7e22ce); }
        .btn-glossy.green { background: linear-gradient(to bottom, #22c55e, #15803d); }
        .btn-glossy.blue { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); }
        .btn-glossy.red { background: linear-gradient(to bottom, #ef4444, #b91c1c); }
        .btn-glossy.teal { background: linear-gradient(to bottom, #14b8a6, #0f766e); }
        .btn-glossy.grey { 
            background: linear-gradient(to bottom, #f5f5f5, #e0e0e0);
            color: #333;
            text-shadow: 0 1px 1px rgba(255,255,255,0.7);
        }

        /* --- ESTILOS PARA ANIMAÇÃO DE ANIVERSÁRIO --- */
        #birthdayOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1001; /* Z-index alto para ficar sobre tudo */
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        #confettiContainer {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #birthdayMessage {
            color: white;
            font-size: 3.5em; /* Aumentado para mais impacto */
            font-weight: bold;
            text-shadow: 3px 3px 8px black;
            z-index: 1002;
            animation: pop-in 0.5s ease-out;
            text-align: center;
        }

        @keyframes pop-in {
            from { transform: scale(0.5) rotate(-15deg); opacity: 0; }
            to { transform: scale(1) rotate(0deg); opacity: 1; }
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            border-radius: 2px;
            opacity: 0.9;
            animation: fall 4s linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(110vh) rotate(720deg);
                opacity: 0;
            }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4 min-h-screen flex flex-col items-center">

    <div id="mainCalendarContainer" class="w-full max-w-3xl mx-auto bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6">
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">Calendário</h1>
        </div>
        <div class="flex justify-center items-center mb-4 space-x-3">
            <button id="toggleViewButton" class="btn-glossy purple text-sm">
                PC
            </button>
            <button id="openSettingsButton" class="btn-glossy blue text-sm">
                Config
            </button>
            <button id="openTipsButton" class="btn-glossy green text-sm">
                Dicas
            </button>
        </div>

        <div id="shiftFilterButtonsContainer" class="my-4 flex flex-wrap justify-center">
        </div>
        
        <div class="flex justify-between items-center mb-4">
            <button id="prevMonth" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
            </button>
            <div class="flex items-center space-x-2">
                <h2 id="currentMonthYear" class="text-xl font-semibold"></h2>
                <button id="summarizeMonthButton" title="Resumir Mês com IA" class="p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-sparkles"><path d="m12 3-1.9 3.9-3.9 1.9 3.9 1.9 1.9 3.9 1.9-3.9 3.9-1.9-3.9-1.9Z"/><path d="M5 12H3"/><path d="M5 22v-2"/><path d="m21 12-2 0"/><path d="m21 22-2-2"/><path d="m12 5 1.5-3"/><path d="M3 5l2 2"/><path d="m19 5-2 2"/></svg>
                </button>
            </div>
            <button id="nextMonth" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
            </button>
        </div>
        <div id="summaryContainer" class="hidden my-4 p-3 bg-blue-50 dark:bg-gray-700 rounded-lg shadow"></div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>

        <div class="mt-4 flex flex-col justify-start items-start space-y-1 text-xs text-gray-600 dark:text-gray-400">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                <span class="font-semibold">Aniversário</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                <span class="font-semibold">Compromissos</span>
            </div>
            <div id="holidayLegendContainer" class="flex flex-col items-start space-y-1">
                </div>
        </div>

        <footer class="text-center mt-6">
            <div class="flex justify-center items-center space-x-2 text-xs text-gray-400 dark:text-gray-500">
                <span>By KleDer</span>
                <span>|</span>
                <a href="mailto:kgfontinelle@gmail.com" class="hover:text-blue-500">kgfontinelle@gmail.com</a>
            </div>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Versão 1.12</p>
        </footer>
    </div>

    <div id="settingsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Configurações da Escala</h3>
                <button id="closeSettingsButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="scheduleType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Escala:</label>
                    <select id="scheduleType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">Configuração das Alas:</h4>
                    <div id="shiftSettingsContainer" class="space-y-3"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-center">
                <button id="saveSettingsButton" class="btn-glossy green">
                    Salvar Configurações
                </button>
            </div>
        </div>
    </div>

    <div id="eventModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="eventModalTitle" class="text-xl font-semibold text-gray-800 dark:text-gray-100">Adicionar/Editar Evento</h3>
                <button id="closeEventModalButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div>
                <label for="eventDescriptionInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrição(ões) do Evento (use "niver" para aniversários; uma por linha):</label>
                <textarea id="eventDescriptionInput" placeholder="Ex: GSV&#10;Niver do João&#10;Consulta médica" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3"></textarea>
            </div>
             <div class="mt-4 flex justify-end items-center gap-2">
                <button id="addToGoogleCalendarButton" title="Adicionar ao Google Agenda" class="btn-glossy blue text-sm flex items-center space-x-1.5">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-plus"><path d="M8 2v4"/><path d="M16 2v4"/><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><line x1="16" x2="22" y1="19" y2="19"/><line x1="19" x2="19" y1="16" y2="22"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
                    <span>Google Agenda</span>
                </button>
                <button id="deleteEventButton" class="btn-glossy red text-sm">
                    Deletar
                </button>
                <button id="saveEventButton" class="btn-glossy green text-sm">
                    Salvar
                </button>
            </div>
        </div>
    </div>

    <div id="tipsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Dicas de Uso</h3>
                <button id="closeTipsModalButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <ul class="space-y-3 text-gray-700 dark:text-gray-300 list-disc list-outside ml-4">
                <li>Para aniversários anuais, escreva "niver" na descrição do evento.</li>
                <li>Clique em qualquer dia para adicionar um compromisso ou lembrete.</li>
                <li>Use o botão "Config" para escolher sua escala ou personalizar as cores das alas.</li>
                <li><strong>Integração com Google Agenda:</strong> Adicione um compromisso e clique em "Google Agenda". Uma nova aba abrirá com tudo preenchido. Salve o evento lá e depois salve aqui no app.</li>
            </ul>
        </div>
    </div>

    <div id="selectAlaForSummaryModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Resumo do Mês</h3>
                <button id="closeSummaryAlaModalButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p class="text-gray-700 dark:text-gray-300 mb-4">Por favor, selecione a sua ala para gerar um resumo personalizado:</p>
            <div id="summaryAlaButtonsContainer" class="flex flex-wrap justify-center gap-3">
                </div>
        </div>
    </div>
    
    <div id="birthdayOverlay" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-[1001]">
        <div id="confettiContainer" class="absolute inset-0"></div>
        <div id="birthdayMessage" class="relative"></div>
    </div>

    <div id="dailyTipModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">💡 Dica do Dia</h3>
                <button id="closeDailyTipModalButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p id="dailyTipText" class="text-gray-700 dark:text-gray-300 mb-4 text-center"></p>
            <div class="flex justify-end">
                <button id="okDailyTipButton" class="btn-glossy blue text-sm">Entendi!</button>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="hidden fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-xs z-[100]" role="alert">
        <span id="toastMessage"></span>
    </div>
    
    <script type="module">
        // Elementos da UI
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const settingsModal = document.getElementById('settingsModal');
        const openSettingsButton = document.getElementById('openSettingsButton');
        const closeSettingsButton = document.getElementById('closeSettingsButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const scheduleTypeSelect = document.getElementById('scheduleType');
        const shiftContainer = document.getElementById('shiftSettingsContainer');
        const toggleViewButton = document.getElementById('toggleViewButton'); 
        const mainCalendarContainer = document.getElementById('mainCalendarContainer'); 
        const shiftFilterButtonsContainer = document.getElementById('shiftFilterButtonsContainer'); 
        const holidayLegendContainer = document.getElementById('holidayLegendContainer'); 

        // Elementos para Eventos
        const eventModal = document.getElementById('eventModal');
        const eventModalTitle = document.getElementById('eventModalTitle');
        const eventDescriptionInput = document.getElementById('eventDescriptionInput');
        const saveEventButton = document.getElementById('saveEventButton');
        const deleteEventButton = document.getElementById('deleteEventButton');
        const closeEventModalButton = document.getElementById('closeEventModalButton');
        const addToGoogleCalendarButton = document.getElementById('addToGoogleCalendarButton');
        
        // Elementos para Dicas
        const tipsModal = document.getElementById('tipsModal');
        const openTipsButton = document.getElementById('openTipsButton');
        const closeTipsModalButton = document.getElementById('closeTipsModalButton');
        
        // Elementos da Dica Diária
        const dailyTipModal = document.getElementById('dailyTipModal');
        const closeDailyTipModalButton = document.getElementById('closeDailyTipModalButton');
        const okDailyTipButton = document.getElementById('okDailyTipButton');
        const dailyTipText = document.getElementById('dailyTipText');

        // Elementos Gemini
        const summarizeMonthButton = document.getElementById('summarizeMonthButton');
        const summaryContainer = document.getElementById('summaryContainer');
        const selectAlaForSummaryModal = document.getElementById('selectAlaForSummaryModal');
        const summaryAlaButtonsContainer = document.getElementById('summaryAlaButtonsContainer');
        const closeSummaryAlaModalButton = document.getElementById('closeSummaryAlaModalButton');
        
        let currentDate = new Date();
        let settings = {
            scheduleType: 'ABCD_24_72', 
            referenceDate: '2025-07-11', 
            startDayOfWeek: 'Sunday',   
            shifts: [ 
                { label: 'A', color: '#FF0000' }, 
                { label: 'B', color: '#00FF00' }, 
                { label: 'C', color: '#FFA500' }, 
                { label: 'D', color: '#FFFF00' }  
            ],
            viewMode: 'desktop',
            filteredShiftLabel: null 
        };
        let events = {}; // Eventos não recorrentes
        let recurringEvents = {}; // Aniversários e outros eventos anuais
        let holidays = {};
        let tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings));
        let currentlyEditingEventDate = null; 

        // Opções de escala simplificadas
        const schedulePatterns = {
            'ABCD_24_72': { name: 'ABCD (24/72)', shiftsInPattern: 4, daysOn: 1, daysOff: 3 },
            'SECOM_UR_12H': { name: 'SECOM / UR', shiftsInPattern: 5, isComplex12h: true, daysInCycle: 5 },
        };

        const secomUrPatternMap = [
            [4, 3], // Dia 1 do ciclo: DS=I(4), NS=H(3)
            [0, 4], // Dia 2 do ciclo: DS=E(0), NS=I(4)
            [1, 0], // Dia 3 do ciclo: DS=F(1), NS=E(0)
            [2, 1], // Dia 4 do ciclo: DS=G(2), NS=F(1)
            [3, 2]  // Dia 5 do ciclo: DS=H(3), NS=G(2)
        ];

        // --- Lógica de Feriados ---
        function getEaster(year) {
            const f = Math.floor,
                G = year % 19,
                C = f(year / 100),
                H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
                I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
                J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
                L = I - J,
                month = 3 + f((L + 40) / 44),
                day = L + 28 - 31 * f(month / 4);
            return new Date(year, month - 1, day);
        }

        function getHolidaysForYear(year) {
            const yearHolidays = {};
            const easter = getEaster(year);

            const addHoliday = (date, name) => {
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                yearHolidays[key] = name;
            };

            // Feriados Fixos
            addHoliday(new Date(year, 0, 1), 'Confraternização Universal');
            addHoliday(new Date(year, 3, 21), 'Tiradentes');
            addHoliday(new Date(year, 4, 1), 'Dia do Trabalho');
            addHoliday(new Date(year, 8, 7), 'Independência do Brasil');
            addHoliday(new Date(year, 9, 12), 'Nossa Senhora Aparecida');
            addHoliday(new Date(year, 10, 2), 'Finados');
            addHoliday(new Date(year, 10, 15), 'Proclamação da República');
            addHoliday(new Date(year, 11, 25), 'Natal');
            
            // Feriados Móveis
            const carnival = new Date(easter);
            carnival.setDate(easter.getDate() - 47);
            addHoliday(carnival, 'Carnaval');

            const goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2);
            addHoliday(goodFriday, 'Paixão de Cristo');
            
            const corpusChristi = new Date(easter);
            corpusChristi.setDate(easter.getDate() + 60);
            addHoliday(corpusChristi, 'Corpus Christi');

            return yearHolidays;
        }

        function loadHolidaysForYear(year) {
            if (!holidays[year]) {
                holidays[year] = getHolidaysForYear(year);
            }
        }

        function updateToggleButtonText() {
            toggleViewButton.textContent = settings.viewMode === 'desktop' ? 'Celular' : 'PC';
        }

        function applySettingsAndRender() { 
            updateSettingsUIInputs(); 
            updateToggleButtonText(); 
            renderShiftFilterButtons(); 
            renderCalendar(); 
        }

        function loadSettingsFromLocalStorage() {
            const storedSettings = localStorage.getItem('fireShiftCalendarSettings');
            if (storedSettings) {
                try {
                    const loadedSettings = JSON.parse(storedSettings);
                    settings = { ...settings, ...loadedSettings };
                    
                    const patternDetails = schedulePatterns[settings.scheduleType]; 
                    const numShiftsRequired = patternDetails ? patternDetails.shiftsInPattern : 4; 

                    if (loadedSettings.shifts && Array.isArray(loadedSettings.shifts) && loadedSettings.shifts.length >= numShiftsRequired) {
                        settings.shifts = loadedSettings.shifts.slice(0, numShiftsRequired).map((s, i) => ({
                            label: s.label || String.fromCharCode(65 + i),
                            color: s.color || '#CCCCCC'
                        }));
                    } else { 
                        initializeDefaultShiftsForScheduleType();
                    }
                } catch (e) {
                    console.error("Erro ao carregar configurações, usando padrões:", e);
                    initializeDefaultSettings(); 
                    saveSettingsToLocalStorage(true);
                }
            } else {
                console.log("Nenhuma configuração encontrada. Usando padrões.");
                initializeDefaultSettings(); 
                saveSettingsToLocalStorage(true); 
            }
            tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings)); 
        }

        function loadEventsFromLocalStorage() {
            const storedEvents = localStorage.getItem('fireShiftEvents');
            if (storedEvents) {
                try {
                    events = JSON.parse(storedEvents);
                } catch (e) {
                    console.error("Erro ao carregar eventos, iniciando vazio:", e);
                    events = {};
                }
            }
            const storedRecurringEvents = localStorage.getItem('fireShiftRecurringEvents');
            if (storedRecurringEvents) {
                try {
                    recurringEvents = JSON.parse(storedRecurringEvents);
                } catch (e) {
                    console.error("Erro ao carregar eventos recorrentes, iniciando vazio:", e);
                    recurringEvents = {};
                }
            }
        }
        
        function initializeDefaultSettings() {
            settings.scheduleType = 'ABCD_24_72';
            settings.referenceDate = '2025-07-11'; 
            settings.startDayOfWeek = 'Sunday';
            settings.viewMode = 'desktop';
            settings.filteredShiftLabel = null;
            initializeDefaultShiftsForScheduleType();
        }

        function initializeDefaultShiftsForScheduleType() {
            const patternDetails = schedulePatterns[settings.scheduleType];
            const numShiftsRequired = patternDetails ? patternDetails.shiftsInPattern : 4;
            let defaultShifts = [];
            if (settings.scheduleType === 'ABCD_24_72') {
                defaultShifts = [
                    { label: 'A', color: '#FF0000' }, { label: 'B', color: '#00FF00' },
                    { label: 'C', color: '#FFA500' }, { label: 'D', color: '#FFFF00' }
                ];
            } else if (settings.scheduleType === 'SECOM_UR_12H') {
                defaultShifts = [
                    { label: 'E', color: '#ff9800' }, // Orange
                    { label: 'F', color: '#e91e63' }, // Pink
                    { label: 'G', color: '#00bcd4' }, // Cyan
                    { label: 'H', color: '#795548' }, // Brown
                    { label: 'I', color: '#9e9e9e' }  // Grey
                ];
            }
            settings.shifts = defaultShifts.slice(0, numShiftsRequired);
        }

        function saveSettingsToLocalStorage(isInitialSave = false) {
            try {
                localStorage.setItem('fireShiftCalendarSettings', JSON.stringify(settings));
                if (!isInitialSave) showToast("Configurações salvas com sucesso!", "success");
                tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings)); 
                return true; 
            } catch (error) {
                console.error("Erro ao salvar configurações:", error);
                if (!isInitialSave) showToast("Erro ao salvar configurações.", "error");
                return false; 
            }
        }
        
        function saveEventsToLocalStorage() {
            try {
                localStorage.setItem('fireShiftEvents', JSON.stringify(events));
                localStorage.setItem('fireShiftRecurringEvents', JSON.stringify(recurringEvents));
            } catch (error) {
                console.error("Erro ao salvar eventos:", error);
                showToast("Erro ao salvar evento.", "error");
            }
        }
        
        function populateScheduleTypes() {  
            scheduleTypeSelect.innerHTML = ''; 
            Object.keys(schedulePatterns).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = schedulePatterns[key].name;
                scheduleTypeSelect.appendChild(option);
            });
        }

        function getShiftsForCalendarDay(dateToCalc) {
            const patternDetails = schedulePatterns[settings.scheduleType];
            if (!patternDetails || !settings.shifts || settings.shifts.length === 0) {
                return { dayShift: null, nightShift: null };
            }

            const [refYear, refMonth, refDay] = settings.referenceDate.split('-').map(Number);
            const refDateUtc = Date.UTC(refYear, refMonth - 1, refDay);
            const currentDateUtc = Date.UTC(dateToCalc.getFullYear(), dateToCalc.getMonth(), dateToCalc.getDate());
            const diffDays = Math.floor((currentDateUtc - refDateUtc) / (1000 * 60 * 60 * 24));

            if (patternDetails.isComplex12h) { 
                let patternMap = secomUrPatternMap;
                const cycleDay = (diffDays % patternDetails.daysInCycle + patternDetails.daysInCycle) % patternDetails.daysInCycle;
                const dayShiftTeamIndex = patternMap[cycleDay][0];
                const nightShiftTeamIndex = patternMap[cycleDay][1];
                return {
                    dayShift: settings.shifts[dayShiftTeamIndex] || null,
                    nightShift: settings.shifts[nightShiftTeamIndex] || null
                };
            } else { 
                const numDistinctTeams = patternDetails.shiftsInPattern; 
                const daysWork = patternDetails.daysOn; 
                if (numDistinctTeams === 0 || daysWork === 0) return { dayShift: null, nightShift: null };
                const fullRotationLength = numDistinctTeams * daysWork;
                if (fullRotationLength === 0) return { dayShift: null, nightShift: null};
                let dayInFullRotation = diffDays % fullRotationLength;
                if (dayInFullRotation < 0) {
                    dayInFullRotation += fullRotationLength;
                }
                const teamTurnIndex = Math.floor(dayInFullRotation / daysWork);
                if (settings.shifts[teamTurnIndex]) {
                    return { dayShift: settings.shifts[teamTurnIndex], nightShift: settings.shifts[teamTurnIndex] };
                }
                return { dayShift: null, nightShift: null }; 
            }
        }

        function lightenColor(hexColor, percent) {
            if (!hexColor || hexColor.length < 7) return '#FFFFFF';
            try {
                const num = parseInt(hexColor.slice(1), 16),
                    amt = Math.round(2.55 * percent),
                    R = (num >> 16) + amt,
                    G = ((num >> 8) & 0x00FF) + amt,
                    B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R > 255 ? 255 : R < 0 ? 0 : R) * 0x10000 + (G > 255 ? 255 : G < 0 ? 0 : G) * 0x100 + (B > 255 ? 255 : B < 0 ? 0 : B)).toString(16).slice(1);
            } catch (e) {
                return '#FFFFFF';
            }
        }

        // --- FUNÇÕES DE BOTÕES DE FILTRO (ALTERADAS) ---
        function createShowAllButton() {
            const button = document.createElement('button');
            button.textContent = 'Todas as Alas';
            const sizeClasses = settings.viewMode === 'mobile' ? 'text-xs py-1 px-3' : 'text-sm';
            button.className = `btn-glossy ${sizeClasses} ${settings.filteredShiftLabel === null ? 'blue' : 'grey'} w-full md:w-auto`;
            button.onclick = () => {
                settings.filteredShiftLabel = null;
                saveSettingsToLocalStorage();
                applySettingsAndRender();
            };
            return button;
        }

        function createAlaButton(shift) {
            const button = document.createElement('button');
            button.textContent = `Ala ${shift.label}`;
            const sizeClasses = settings.viewMode === 'mobile' ? 'text-xs py-1 px-3' : 'text-sm';
            button.className = `btn-glossy ${sizeClasses}`;
            
            if (settings.filteredShiftLabel === shift.label) {
                button.style.background = `linear-gradient(to bottom, ${lightenColor(shift.color, 30)}, ${shift.color})`;
                button.style.color = getContrastColor(shift.color);
            } else {
                 button.classList.add('grey');
            }

            button.onclick = () => {
                settings.filteredShiftLabel = shift.label;
                saveSettingsToLocalStorage();
                applySettingsAndRender();
            };
            return button;
        }

        function renderShiftFilterButtons() {
            shiftFilterButtonsContainer.innerHTML = '';
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            if (!patternDetails || !settings.shifts || !settings.shifts.length) return;

            shiftFilterButtonsContainer.className = 'my-4 flex flex-wrap justify-center gap-2';

            const showAllButton = createShowAllButton();
            shiftFilterButtonsContainer.appendChild(showAllButton);

            const sortedShifts = [...settings.shifts].sort((a, b) => a.label.localeCompare(b.label));

            sortedShifts.forEach((shift) => {
                shiftFilterButtonsContainer.appendChild(createAlaButton(shift));
            });
        }


        function renderCalendar() {  
            if (settings.viewMode === 'mobile') {
                mainCalendarContainer.classList.remove('max-w-3xl');
                mainCalendarContainer.classList.add('max-w-md'); 
                currentMonthYear.classList.remove('text-xl');
                currentMonthYear.classList.add('text-lg');
            } else { 
                mainCalendarContainer.classList.remove('max-w-md');
                mainCalendarContainer.classList.add('max-w-3xl');
                currentMonthYear.classList.remove('text-lg');
                currentMonthYear.classList.add('text-xl');
            }

            calendarGrid.innerHTML = ''; 
            currentMonthYear.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${currentDate.getFullYear()}`;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            loadHolidaysForYear(year); 

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startingDay = firstDayOfMonth.getDay(); 
            if (settings.startDayOfWeek === 'Monday') startingDay = (startingDay === 0) ? 6 : startingDay - 1; 
            
            const dayHeadersBaseClasses = 'font-semibold text-center';
            const dayHeaders = (settings.startDayOfWeek === 'Monday') ? ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'] : ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            dayHeaders.forEach(header => {
                const dayHeaderCell = document.createElement('div');
                let headerClasses = dayHeadersBaseClasses;
                if (settings.viewMode === 'mobile') {
                    headerClasses += ' text-xs py-1 text-gray-500 dark:text-gray-400';
                } else {
                    headerClasses += ' text-sm py-2 text-gray-600 dark:text-gray-300';
                }
                dayHeaderCell.className = headerClasses;
                dayHeaderCell.textContent = header;
                calendarGrid.appendChild(dayHeaderCell);
            });

            for (let i = 0; i < startingDay; i++) calendarGrid.appendChild(document.createElement('div'));
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            const is12hPattern = patternDetails && (patternDetails.isComplex12h || patternDetails.isSimple12h);

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                let cellClasses = 'border-2 shadow-sm rounded-tr-2xl rounded-bl-2xl text-center flex flex-col justify-start items-center cursor-pointer overflow-hidden relative';
                if (settings.viewMode === 'mobile') {
                    cellClasses += ` ${is12hPattern ? 'p-0 min-h-[60px]' : 'p-1 min-h-[50px]'}`; 
                } else {
                    cellClasses += ` ${is12hPattern ? 'p-0 min-h-[80px]' : 'p-2 min-h-[70px]'}`; 
                }
                dayCell.className = cellClasses;

                const currentIterationDate = new Date(year, month, day);
                currentIterationDate.setHours(0, 0, 0, 0);
                
                if (currentIterationDate.getTime() === today.getTime()) {
                    dayCell.classList.add('animate-pulse', 'border-blue-700', 'dark:border-blue-500', 'border-b-4', 'shadow-lg', 'z-10');
                }

                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.className = `font-bold self-start z-10 ${settings.viewMode === 'mobile' ? 'text-xs p-1.5' : 'text-sm p-2'}`;
                dayNumberSpan.textContent = day;
                
                const shiftsDisplayContainer = document.createElement('div');
                shiftsDisplayContainer.className = 'w-full flex flex-col justify-around items-center flex-grow';

                const actualShifts = getShiftsForCalendarDay(currentIterationDate); 

                let displayDayShift = null;
                let displayNightShift = null;

                if (settings.filteredShiftLabel) {
                    if (actualShifts.dayShift && actualShifts.dayShift.label === settings.filteredShiftLabel) displayDayShift = actualShifts.dayShift;
                    if (actualShifts.nightShift && actualShifts.nightShift.label === settings.filteredShiftLabel) displayNightShift = actualShifts.nightShift;
                } else { 
                    displayDayShift = actualShifts.dayShift;
                    displayNightShift = actualShifts.nightShift;
                }

                if (is12hPattern) {
                    dayCell.appendChild(dayNumberSpan); 
                    
                    const dayShiftDiv = document.createElement('div');
                    dayShiftDiv.className = `w-full text-center flex-1 flex items-center justify-center font-bold ${settings.viewMode === 'mobile' ? 'text-sm' : 'text-base'}`;
                    if (displayDayShift) {
                        const startColor = lightenColor(displayDayShift.color, 25);
                        dayShiftDiv.style.background = `linear-gradient(to bottom, ${startColor}, ${displayDayShift.color})`;
                        dayShiftDiv.style.color = getContrastColor(displayDayShift.color);
                        dayShiftDiv.textContent = displayDayShift.label + (settings.viewMode === 'desktop' ? ' (Dia)' : ' D');
                    } else {
                        dayShiftDiv.innerHTML = `&nbsp;`; 
                        if (settings.filteredShiftLabel) dayShiftDiv.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    shiftsDisplayContainer.appendChild(dayShiftDiv);

                    const nightShiftDiv = document.createElement('div');
                    nightShiftDiv.className = `w-full text-center flex-1 flex items-center justify-center font-bold ${settings.viewMode === 'mobile' ? 'text-sm' : 'text-base'}`;
                     if (displayNightShift) {
                        const startColor = lightenColor(displayNightShift.color, 25);
                        nightShiftDiv.style.background = `linear-gradient(to bottom, ${startColor}, ${displayNightShift.color})`;
                        nightShiftDiv.style.color = getContrastColor(displayNightShift.color);
                        nightShiftDiv.textContent = displayNightShift.label + (settings.viewMode === 'desktop' ? ' (Noite)' : ' N');
                    } else {
                        nightShiftDiv.innerHTML = `&nbsp;`;
                        if (settings.filteredShiftLabel) nightShiftDiv.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    shiftsDisplayContainer.appendChild(nightShiftDiv);
                    dayCell.appendChild(shiftsDisplayContainer);

                } else { 
                    dayCell.appendChild(dayNumberSpan);
                    if (displayDayShift) {
                        const startColor = lightenColor(displayDayShift.color, 25);
                        dayCell.style.background = `linear-gradient(to bottom, ${startColor}, ${displayDayShift.color})`;
                        const contrastColor = getContrastColor(displayDayShift.color);
                        dayNumberSpan.style.color = contrastColor; 
                        const shiftLabel = document.createElement('span');
                        shiftLabel.className = `font-bold flex-grow flex items-center justify-center ${settings.viewMode === 'mobile' ? 'text-lg' : 'text-xl'}`;
                        shiftLabel.style.color = contrastColor; 
                        shiftLabel.textContent = displayDayShift.label;
                        shiftsDisplayContainer.appendChild(shiftLabel);
                    } else {
                        dayNumberSpan.classList.add(settings.viewMode === 'mobile' ? 'text-gray-700' : 'text-gray-800', 'dark:text-gray-200');
                        if (settings.filteredShiftLabel) dayCell.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    dayCell.appendChild(shiftsDisplayContainer);
                }

                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const recurringDateKey = `${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const indicatorsTopLeft = document.createElement('div');
                indicatorsTopLeft.className = 'absolute top-1 left-1 flex space-x-1 z-20';

                const indicatorsTopRight = document.createElement('div');
                indicatorsTopRight.className = 'absolute top-1 right-1 flex space-x-1 z-20';

                const indicatorsBottomLeft = document.createElement('div');
                indicatorsBottomLeft.className = 'absolute bottom-1 left-1 flex space-x-1 z-20';

                if (recurringEvents[recurringDateKey]) {
                    const anniversaryDot = document.createElement('div');
                    anniversaryDot.className = 'w-2 h-2 bg-yellow-400 rounded-full ring-1 ring-white dark:ring-black';
                    anniversaryDot.title = `Aniversário: ${recurringEvents[recurringDateKey]}`;
                    indicatorsTopLeft.appendChild(anniversaryDot);
                }

                if (holidays[year] && holidays[year][dateKey]) {
                    const holidayDot = document.createElement('div');
                    holidayDot.className = 'w-2 h-2 bg-red-500 rounded-full ring-1 ring-white dark:ring-black';
                    holidayDot.title = `Feriado: ${holidays[year][dateKey]}`;
                    indicatorsTopRight.appendChild(holidayDot);
                }

                if (events[dateKey]) { 
                    const eventDot = document.createElement('div');
                    eventDot.className = 'w-2 h-2 bg-blue-500 rounded-full ring-1 ring-white dark:ring-black';
                    eventDot.title = `Evento: ${events[dateKey]}`;
                    indicatorsBottomLeft.appendChild(eventDot);
                }
                
                dayCell.appendChild(indicatorsTopLeft);
                dayCell.appendChild(indicatorsTopRight);
                dayCell.appendChild(indicatorsBottomLeft);
                
                dayCell.addEventListener('click', () => openEventModal(currentIterationDate));
                calendarGrid.appendChild(dayCell);
            }

            holidayLegendContainer.innerHTML = ''; 
            const holidaysThisMonth = [];
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (holidays[year] && holidays[year][dateKey]) {
                    holidaysThisMonth.push({ day, name: holidays[year][dateKey] });
                }
            }

            if (holidaysThisMonth.length > 0) {
                holidaysThisMonth.forEach(holiday => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center space-x-2';
                    
                    const dot = document.createElement('div');
                    dot.className = 'w-2 h-2 bg-red-500 rounded-full flex-shrink-0';
                    
                    const text = document.createElement('span');
                    text.className = 'font-semibold';
                    const formattedDate = `${String(holiday.day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}`;
                    text.textContent = `${formattedDate} - ${holiday.name}`;

                    legendItem.appendChild(dot);
                    legendItem.appendChild(text);
                    holidayLegendContainer.appendChild(legendItem);
                });
            }
        }

        function openEventModal(date) {
            currentlyEditingEventDate = date;
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const recurringDateKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            
            eventModalTitle.textContent = `Evento para ${date.toLocaleDateString('pt-BR')}`;
            
            const recurringText = recurringEvents[recurringDateKey] || '';
            const eventText = events[dateKey] || '';
            eventDescriptionInput.value = [recurringText, eventText].filter(Boolean).join('\n');
            eventDescriptionInput.classList.remove('hidden');

            eventModal.classList.remove('hidden');
        }

        function handleAddToGoogleCalendar() {
            if (!currentlyEditingEventDate) {
                showToast("Nenhuma data selecionada.", "error");
                return;
            }

            const eventText = eventDescriptionInput.value.trim();
            if (!eventText) {
                showToast("Por favor, adicione uma descrição para o evento.", "info");
                return;
            }

            const year = currentlyEditingEventDate.getFullYear();
            const month = String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0');
            const day = String(currentlyEditingEventDate.getDate()).padStart(2, '0');
            const startDate = `${year}${month}${day}`;

            // Para eventos de dia inteiro, o Google Agenda espera que a data final seja o dia seguinte.
            const nextDay = new Date(currentlyEditingEventDate);
            nextDay.setDate(nextDay.getDate() + 1);
            const nextYear = nextDay.getFullYear();
            const nextMonth = String(nextDay.getMonth() + 1).padStart(2, '0');
            const nextDayOfMonth = String(nextDay.getDate()).padStart(2, '0');
            const endDate = `${nextYear}${nextMonth}${nextDayOfMonth}`;

            const encodedText = encodeURIComponent(eventText);
            
            const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodedText}&dates=${startDate}/${endDate}`;

            window.open(googleCalendarUrl, '_blank');
        }

        closeEventModalButton.addEventListener('click', () => eventModal.classList.add('hidden'));

        saveEventButton.addEventListener('click', () => {
            if (currentlyEditingEventDate) {
                const dateKey = `${currentlyEditingEventDate.getFullYear()}-${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                const recurringDateKey = `${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                const descriptionLines = eventDescriptionInput.value.trim().split('\n');

                const niverLines = descriptionLines.filter(line => line.toLowerCase().includes('niver'));
                const eventLines = descriptionLines.filter(line => !line.toLowerCase().includes('niver'));

                if (niverLines.length > 0) {
                    recurringEvents[recurringDateKey] = niverLines.join('\n');
                } else {
                    delete recurringEvents[recurringDateKey];
                }

                if (eventLines.length > 0) {
                    events[dateKey] = eventLines.join('\n');
                } else {
                    delete events[dateKey];
                }

                showToast("Eventos salvos!", "success");
                saveEventsToLocalStorage();
                renderCalendar();
                eventModal.classList.add('hidden');

                if (niverLines.length > 0) {
                    playBirthdayAnimation(niverLines[0]);
                }
            }
        });

        deleteEventButton.addEventListener('click', () => {
            if (currentlyEditingEventDate) {
                const dateKey = `${currentlyEditingEventDate.getFullYear()}-${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                const recurringDateKey = `${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                
                let eventDeleted = false;
                if (events[dateKey]) {
                    delete events[dateKey];
                    eventDeleted = true;
                }
                if (recurringEvents[recurringDateKey]) {
                    delete recurringEvents[recurringDateKey];
                    eventDeleted = true;
                }

                if(eventDeleted) {
                    showToast("Evento deletado!", "info");
                    saveEventsToLocalStorage();
                    renderCalendar();
                }
                eventModal.classList.add('hidden');
            }
        });


        function getContrastColor(hexColor) { 
            if (!hexColor || hexColor.length < 7) return '#000000'; 
            try {
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#FFFFFF';
            } catch (e) {
                console.error("Erro ao parsear cor hexadecimal:", hexColor, e);
                return '#000000'; 
            }
        }

        function darkenColor(hexColor, percent) {
            if (!hexColor || hexColor.length < 7) return '#555555';
            try {
                const num = parseInt(hexColor.slice(1), 16),
                    amt = Math.round(2.55 * percent),
                    R = (num >> 16) - amt,
                    G = ((num >> 8) & 0x00FF) - amt,
                    B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            } catch (e) {
                console.error("Erro ao escurecer a cor:", hexColor, e);
                return '#555555'; // fallback
            }
        }

        function updateSettingsUIInputs() {  
            scheduleTypeSelect.value = settings.scheduleType;
            shiftContainer.innerHTML = ''; 
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            const numShiftsToDisplay = patternDetails ? patternDetails.shiftsInPattern : (settings.shifts ? settings.shifts.length : 0);
            
            if (!settings.shifts) settings.shifts = [];
            
            let currentDefaultShifts = [];
            if (settings.scheduleType === 'ABCD_24_72') {
                currentDefaultShifts = [
                    { label: 'A', color: '#FF0000' }, { label: 'B', color: '#00FF00' },
                    { label: 'C', color: '#FFA500' }, { label: 'D', color: '#FFFF00' }
                ];
            } else if (settings.scheduleType === 'SECOM_UR_12H') {
                currentDefaultShifts = [
                    { label: 'E', color: '#ff9800' }, { label: 'F', color: '#e91e63' },
                    { label: 'G', color: '#00bcd4' }, { label: 'H', color: '#795548' },
                    { label: 'I', color: '#9e9e9e' }
                ];
            }

            const finalShifts = [];
            for (let i = 0; i < numShiftsToDisplay; i++) {
                if (settings.shifts[i] && settings.shifts[i].label && settings.shifts[i].color) { 
                    finalShifts.push(settings.shifts[i]);
                } else if (currentDefaultShifts[i]) { 
                    finalShifts.push(currentDefaultShifts[i]);
                } else { 
                    finalShifts.push({ label: String.fromCharCode(65 + i), color: '#CCCCCC' });
                }
            }
            settings.shifts = finalShifts.slice(0, numShiftsToDisplay); 


            for (let i = 0; i < numShiftsToDisplay; i++) {
                const currentShiftConfig = settings.shifts[i]; 
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 mb-2';
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.value = currentShiftConfig.label;
                labelInput.maxLength = 3;
                labelInput.className = 'w-16 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white';
                labelInput.onchange = (e) => { settings.shifts[i].label = e.target.value; }; 
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = currentShiftConfig.color;
                colorInput.className = 'w-12 h-10 p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600';
                colorInput.disabled = false; 
                colorInput.title = "";
                colorInput.classList.remove('cursor-not-allowed', 'opacity-70');
                colorInput.onchange = (e) => { 
                    settings.shifts[i].color = e.target.value; 
                }; 
                
                const shiftTitle = document.createElement('span');
                shiftTitle.className = 'text-sm font-medium text-gray-700 dark:text-gray-300';
                shiftTitle.textContent = `Ala ${i + 1}:`; 
                div.appendChild(shiftTitle);
                div.appendChild(labelInput);
                div.appendChild(colorInput);
                shiftContainer.appendChild(div);
            }
        }
        
        toggleViewButton.addEventListener('click', () => {
            settings.viewMode = settings.viewMode === 'desktop' ? 'mobile' : 'desktop';
            saveSettingsToLocalStorage();
            applySettingsAndRender(); 
        });

        prevMonthButton.addEventListener('click', () => {  
            currentDate.setMonth(currentDate.getMonth() - 1);
            summaryContainer.classList.add('hidden');
            summaryContainer.innerHTML = '';
            renderCalendar(); 
        });
        nextMonthButton.addEventListener('click', () => {  
            currentDate.setMonth(currentDate.getMonth() + 1);
            summaryContainer.classList.add('hidden');
            summaryContainer.innerHTML = '';
            renderCalendar(); 
        });
        openSettingsButton.addEventListener('click', () => {  
            settings = JSON.parse(JSON.stringify(tempSettingsBeforeEdit)); 
            updateSettingsUIInputs(); 
            settingsModal.classList.remove('hidden');
        });
        closeSettingsButton.addEventListener('click', () => {  
            settingsModal.classList.add('hidden');
            settings = JSON.parse(JSON.stringify(tempSettingsBeforeEdit));
            applySettingsAndRender(); 
        });
        saveSettingsButton.addEventListener('click', async () => { 
            settings.scheduleType = scheduleTypeSelect.value;
            settings.filteredShiftLabel = null; 
            
            if (settings.scheduleType === 'SECOM_UR_12H') {
                settings.referenceDate = '2025-07-13';
            } else if (settings.scheduleType === 'ABCD_24_72') {
                settings.referenceDate = '2025-07-11';
            }

            const success = saveSettingsToLocalStorage(); 
            if (success) {
                settingsModal.classList.add('hidden');
                applySettingsAndRender(); 
            }
        });
        scheduleTypeSelect.addEventListener('change', (e) => {  
            const newScheduleType = e.target.value;
            settings.scheduleType = newScheduleType; 
            initializeDefaultShiftsForScheduleType(); 
            
            if (newScheduleType === 'SECOM_UR_12H') {
                settings.referenceDate = '2025-07-13';
            } else if (newScheduleType === 'ABCD_24_72') {
                settings.referenceDate = '2025-07-11';
            }
            
            settings.filteredShiftLabel = null; 
            updateSettingsUIInputs(); 
        });

        openTipsButton.addEventListener('click', () => tipsModal.classList.remove('hidden'));
        closeTipsModalButton.addEventListener('click', () => tipsModal.classList.add('hidden'));
        addToGoogleCalendarButton.addEventListener('click', handleAddToGoogleCalendar);

        function showToast(message, type = 'info') {  
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = 'fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-xs z-[100] opacity-0 transition-opacity duration-500'; 
            if (type === 'success') toast.classList.add('bg-green-600');
            else if (type === 'error') toast.classList.add('bg-red-600');
            else toast.classList.add('bg-blue-600');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500); 
            }, 3000);
        }

        // --- Lógica da API Gemini ---

        const geminiApiKey = ""; // A chave será injetada em tempo de execução

        async function callGemini(prompt) {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${geminiApiKey}`;
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro da API Gemini:", errorData);
                    throw new Error(`Erro da API: ${errorData.error?.message || response.statusText}`);
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0]) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    throw new Error("Não foi possível obter uma resposta da IA.");
                }
            } catch (error) {
                console.error("Erro ao chamar a API Gemini:", error);
                showToast(`Erro na IA: ${error.message}.`, "error");
                return null;
            }
        }

        summarizeMonthButton.addEventListener('click', async () => {
            summaryAlaButtonsContainer.innerHTML = '';
            const sortedShifts = [...settings.shifts].sort((a, b) => a.label.localeCompare(b.label));

            sortedShifts.forEach(shift => {
                const button = document.createElement('button');
                button.textContent = `Ala ${shift.label}`;
                button.className = 'py-2 px-4 rounded-lg shadow text-sm font-semibold transition-colors';
                button.style.backgroundColor = shift.color;
                button.style.color = getContrastColor(shift.color);
                button.onclick = () => generateSummaryForAla(shift.label);
                summaryAlaButtonsContainer.appendChild(button);
            });
            selectAlaForSummaryModal.classList.remove('hidden');
        });

        closeSummaryAlaModalButton.addEventListener('click', () => selectAlaForSummaryModal.classList.add('hidden'));

        async function generateSummaryForAla(selectedAlaLabel) {
            selectAlaForSummaryModal.classList.add('hidden');
            summaryContainer.classList.remove('hidden');
            summaryContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 animate-pulse">Analisando o mês para a sua ala... ✨</p>';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const monthName = currentDate.toLocaleString('pt-BR', { month: 'long' });
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let myWorkDays = [];
            let myDaysOff = [];
            let holidaysOnWorkDays = [];
            let holidaysOnDaysOff = [];
            let eventsInMonth = [];
            let anniversariesInMonth = [];

            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const shifts = getShiftsForCalendarDay(date);
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const holidayName = holidays[year] ? holidays[year][dateKey] : null;

                let isMyWorkDay = (shifts.dayShift && shifts.dayShift.label === selectedAlaLabel) || (shifts.nightShift && shifts.nightShift.label === selectedAlaLabel);

                if (isMyWorkDay) {
                    myWorkDays.push(day);
                    if (holidayName) {
                        holidaysOnWorkDays.push(`${day} - ${holidayName}`);
                    }
                } else {
                    myDaysOff.push(day);
                    if (holidayName) {
                        holidaysOnDaysOff.push(`${day} - ${holidayName}`);
                    }
                }

                if (events[dateKey]) {
                    eventsInMonth.push(`${day}: ${events[dateKey]}`);
                }
                const recurringDateKey = `${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if(recurringEvents[recurringDateKey]) {
                    anniversariesInMonth.push(`${day}: ${recurringEvents[recurringDateKey]}`);
                }
            }

            const prompt = `
                Aja como um assistente pessoal para um bombeiro da Ala ${selectedAlaLabel}. Resuma de forma amigável e concisa o mês de ${monthName} de ${year}, com foco na minha rotina.
                Use os seguintes dados:
                - Minha escala de serviço é: ${schedulePatterns[settings.scheduleType].name}.
                - Meus dias de SERVIÇO são: ${myWorkDays.length > 0 ? myWorkDays.join(', ') : 'nenhum'}.
                - Meus dias de FOLGA são: ${myDaysOff.length > 0 ? myDaysOff.join(', ') : 'nenhum'}.
                - Feriados que caem em dias de SERVIÇO: ${holidaysOnWorkDays.length > 0 ? holidaysOnWorkDays.join('; ') : 'nenhum'}.
                - Feriados que poderei aproveitar na FOLGA: ${holidaysOnDaysOff.length > 0 ? holidaysOnDaysOff.join('; ') : 'nenhum'}.
                - Meus eventos pessoais agendados: ${eventsInMonth.length > 0 ? eventsInMonth.join('; ') : 'nenhum'}.
                - Aniversários para lembrar: ${anniversariesInMonth.length > 0 ? anniversariesInMonth.join('; ') : 'nenhum'}.

                Crie um parágrafo de resumo, começando com "Olá, Ala ${selectedAlaLabel}!", e destaque os pontos mais importantes para o meu planejamento.
            `;

            const summaryText = await callGemini(prompt);
            if(summaryText) {
                 summaryContainer.innerHTML = `<p class="text-sm">${summaryText.replace(/\n/g, '<br>')}</p>`;
            } else {
                 summaryContainer.innerHTML = '<p class="text-center text-red-500">Não foi possível gerar o resumo.</p>';
            }
        }
        
        // --- LÓGICA DE DICA DIÁRIA ---
        const dailyTips = [
            'Para que os aniversários fiquem gravados para os anos subsequentes, escreva "niver" antes do nome da pessoa.',
            'Nas configurações, você pode escolher qual escala quer ver e modificar as cores ou as legendas das alas.',
            'Clique em qualquer dia para adicionar um evento pessoal, como uma consulta ou um lembrete.',
            'Novo! Adicione seus compromissos diretamente no Google Agenda usando o botão "Google Agenda" na janela de eventos.',
            'Use o botão com o ícone ✨ no cabeçalho do mês para receber um resumo inteligente da sua escala, feito com IA.'
        ];

        function showDailyTip() {
            const randomIndex = Math.floor(Math.random() * dailyTips.length);
            dailyTipText.textContent = dailyTips[randomIndex];
            dailyTipModal.classList.remove('hidden');
        }

        function closeDailyTip() {
            dailyTipModal.classList.add('hidden');
        }

        closeDailyTipModalButton.addEventListener('click', closeDailyTip);
        okDailyTipButton.addEventListener('click', closeDailyTip);


        // --- LÓGICA DE ANIVERSÁRIO SURPRESA (Refatorada) ---
        function createConfetti() {
            const container = document.getElementById('confettiContainer');
            if (!container) return;
            container.innerHTML = ''; 
            
            const confettiColors = settings.shifts.map(s => s.color);
            if(confettiColors.length === 0) confettiColors.push('#e74c3c', '#3498db', '#f1c40f');

            for (let i = 0; i < 150; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = `${Math.random() * 100}vw`;
                confetti.style.top = `${Math.random() * -50}vh`;
                confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
                confetti.style.animationDelay = `${Math.random() * 2}s`;
                container.appendChild(confetti);
            }
        }

        function playBirthdayAnimation(eventName) {
            const overlay = document.getElementById('birthdayOverlay');
            const messageElement = document.getElementById('birthdayMessage');
            
            let name = eventName.replace(/niver d[oae]\s*/i, '').trim();
            
            messageElement.textContent = `Parabéns, ${name}!`;
            overlay.classList.remove('hidden');

            createConfetti();

            setTimeout(() => {
                overlay.classList.add('hidden');
            }, 4000); 
        }

        function checkAndTriggerBirthdayOnLoad() {
            const today = new Date();
            const recurringDateKey = `${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
            
            const birthdayEventText = recurringEvents[recurringDateKey];

            if (birthdayEventText) {
                const firstBirthday = birthdayEventText.split('\n')[0];
                playBirthdayAnimation(firstBirthday);
            }
        }

        // --- INICIALIZAÇÃO DO APP ---
        populateScheduleTypes();
        loadSettingsFromLocalStorage(); 
        loadEventsFromLocalStorage();
        applySettingsAndRender();
        showDailyTip();
        checkAndTriggerBirthdayOnLoad(); 

    </script>
</body>
</html>