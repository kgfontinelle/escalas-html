<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Escalas de Serviço</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Elementos da UI
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const settingsModal = document.getElementById('settingsModal');
        const openSettingsButton = document.getElementById('openSettingsButton');
        const closeSettingsButton = document.getElementById('closeSettingsButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const scheduleTypeSelect = document.getElementById('scheduleType');
        const shiftContainer = document.getElementById('shiftSettingsContainer');
        const toggleViewButton = document.getElementById('toggleViewButton'); 
        const mainCalendarContainer = document.getElementById('mainCalendarContainer'); 
        const shiftFilterButtonsContainer = document.getElementById('shiftFilterButtonsContainer'); 
        const holidayLegendContainer = document.getElementById('holidayLegendContainer'); 
        const bodyElement = document.body;

        // Elementos para Eventos
        const eventModal = document.getElementById('eventModal');
        const eventModalTitle = document.getElementById('eventModalTitle');
        const eventDescriptionInput = document.getElementById('eventDescriptionInput');
        const saveEventButton = document.getElementById('saveEventButton');
        const deleteEventButton = document.getElementById('deleteEventButton');
        const closeEventModalButton = document.getElementById('closeEventModalButton');
        
        // Elementos para Dicas
        const tipsModal = document.getElementById('tipsModal');
        const openTipsButton = document.getElementById('openTipsButton');
        const closeTipsModalButton = document.getElementById('closeTipsModalButton');

        // Elementos Gemini
        const summarizeMonthButton = document.getElementById('summarizeMonthButton');
        const summaryContainer = document.getElementById('summaryContainer');
        const suggestActivityButton = document.getElementById('suggestActivityButton');
        const suggestionLoadingText = document.getElementById('suggestionLoadingText');
        const selectAlaForSummaryModal = document.getElementById('selectAlaForSummaryModal');
        const summaryAlaButtonsContainer = document.getElementById('summaryAlaButtonsContainer');
        const closeSummaryAlaModalButton = document.getElementById('closeSummaryAlaModalButton');
        
        let currentDate = new Date();
        let settings = {
            scheduleType: 'ABCD_24_72', 
            referenceDate: '2025-07-11', 
            startDayOfWeek: 'Sunday',    
            shifts: [ 
                { label: 'A', color: '#FF0000' }, 
                { label: 'B', color: '#00FF00' }, 
                { label: 'C', color: '#FFA500' }, 
                { label: 'D', color: '#FFFF00' }  
            ],
            viewMode: 'desktop',
            filteredShiftLabel: null 
        };
        let events = {}; // Eventos não recorrentes
        let recurringEvents = {}; // Aniversários e outros eventos anuais
        let holidays = {};
        let tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings));
        let currentlyEditingEventDate = null; 

        // Opções de escala simplificadas
        const schedulePatterns = {
            'ABCD_24_72': { name: 'ABCD (24/72)', shiftsInPattern: 4, daysOn: 1, daysOff: 3 },
            'SECOM_UR_12H': { name: 'SECOM / UR', shiftsInPattern: 5, isComplex12h: true, daysInCycle: 5 },
        };

        const secomUrPatternMap = [
            [4, 3], // Dia 1 do ciclo: DS=I(4), NS=H(3)
            [0, 4], // Dia 2 do ciclo: DS=E(0), NS=I(4)
            [1, 0], // Dia 3 do ciclo: DS=F(1), NS=E(0)
            [2, 1], // Dia 4 do ciclo: DS=G(2), NS=F(1)
            [3, 2]  // Dia 5 do ciclo: DS=H(3), NS=G(2)
        ];

        // --- Lógica de Feriados ---
        function getEaster(year) {
            const f = Math.floor,
                G = year % 19,
                C = f(year / 100),
                H = (C - f(C / 4) - f((8 * C + 13) / 25) + 19 * G + 15) % 30,
                I = H - f(H / 28) * (1 - f(29 / (H + 1)) * f((21 - G) / 11)),
                J = (year + f(year / 4) + I + 2 - C + f(C / 4)) % 7,
                L = I - J,
                month = 3 + f((L + 40) / 44),
                day = L + 28 - 31 * f(month / 4);
            return new Date(year, month - 1, day);
        }

        function getHolidaysForYear(year) {
            const yearHolidays = {};
            const easter = getEaster(year);

            const addHoliday = (date, name) => {
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                yearHolidays[key] = name;
            };

            // Feriados Fixos
            addHoliday(new Date(year, 0, 1), 'Confraternização Universal');
            addHoliday(new Date(year, 3, 21), 'Tiradentes');
            addHoliday(new Date(year, 4, 1), 'Dia do Trabalho');
            addHoliday(new Date(year, 8, 7), 'Independência do Brasil');
            addHoliday(new Date(year, 9, 12), 'Nossa Senhora Aparecida');
            addHoliday(new Date(year, 10, 2), 'Finados');
            addHoliday(new Date(year, 10, 15), 'Proclamação da República');
            addHoliday(new Date(year, 11, 25), 'Natal');
            
            // Feriados Móveis
            const carnival = new Date(easter);
            carnival.setDate(easter.getDate() - 47);
            addHoliday(carnival, 'Carnaval');

            const goodFriday = new Date(easter);
            goodFriday.setDate(easter.getDate() - 2);
            addHoliday(goodFriday, 'Paixão de Cristo');
            
            const corpusChristi = new Date(easter);
            corpusChristi.setDate(easter.getDate() + 60);
            addHoliday(corpusChristi, 'Corpus Christi');

            return yearHolidays;
        }

        function loadHolidaysForYear(year) {
            if (!holidays[year]) {
                holidays[year] = getHolidaysForYear(year);
            }
        }

        function updateToggleButtonText() {
            toggleViewButton.textContent = settings.viewMode === 'desktop' ? 'Celular' : 'PC';
        }

        function applySettingsAndRender() { 
            updateSettingsUIInputs(); 
            updateToggleButtonText(); 
            renderShiftFilterButtons(); 
            renderCalendar(); 
        }

        function loadSettingsFromLocalStorage() {
            const storedSettings = localStorage.getItem('fireShiftCalendarSettings');
            if (storedSettings) {
                try {
                    const loadedSettings = JSON.parse(storedSettings);
                    settings = { ...settings, ...loadedSettings };
                    
                    const patternDetails = schedulePatterns[settings.scheduleType]; 
                    const numShiftsRequired = patternDetails ? patternDetails.shiftsInPattern : 4; 

                    if (loadedSettings.shifts && Array.isArray(loadedSettings.shifts) && loadedSettings.shifts.length >= numShiftsRequired) {
                        settings.shifts = loadedSettings.shifts.slice(0, numShiftsRequired).map((s, i) => ({
                            label: s.label || String.fromCharCode(65 + i),
                            color: s.color || '#CCCCCC'
                        }));
                    } else { 
                        initializeDefaultShiftsForScheduleType();
                    }
                } catch (e) {
                    console.error("Erro ao carregar configurações, usando padrões:", e);
                    initializeDefaultSettings(); 
                    saveSettingsToLocalStorage(true);
                }
            } else {
                console.log("Nenhuma configuração encontrada. Usando padrões.");
                initializeDefaultSettings(); 
                saveSettingsToLocalStorage(true); 
            }
            tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings)); 
        }

        function loadEventsFromLocalStorage() {
            const storedEvents = localStorage.getItem('fireShiftEvents');
            if (storedEvents) {
                try {
                    events = JSON.parse(storedEvents);
                } catch (e) {
                    console.error("Erro ao carregar eventos, iniciando vazio:", e);
                    events = {};
                }
            }
            const storedRecurringEvents = localStorage.getItem('fireShiftRecurringEvents');
            if (storedRecurringEvents) {
                try {
                    recurringEvents = JSON.parse(storedRecurringEvents);
                } catch (e) {
                    console.error("Erro ao carregar eventos recorrentes, iniciando vazio:", e);
                    recurringEvents = {};
                }
            }
        }
        
        function initializeDefaultSettings() {
            settings.scheduleType = 'ABCD_24_72';
            settings.referenceDate = '2025-07-11'; 
            settings.startDayOfWeek = 'Sunday';
            settings.viewMode = 'desktop';
            settings.filteredShiftLabel = null;
            initializeDefaultShiftsForScheduleType();
        }

        function initializeDefaultShiftsForScheduleType() {
            const patternDetails = schedulePatterns[settings.scheduleType];
            const numShiftsRequired = patternDetails ? patternDetails.shiftsInPattern : 4;
            let defaultShifts = [];
            if (settings.scheduleType === 'ABCD_24_72') {
                defaultShifts = [
                    { label: 'A', color: '#FF0000' }, { label: 'B', color: '#00FF00' },
                    { label: 'C', color: '#FFA500' }, { label: 'D', color: '#FFFF00' }
                ];
            } else if (settings.scheduleType === 'SECOM_UR_12H') {
                defaultShifts = [
                    { label: 'E', color: '#ff9800' }, // Orange
                    { label: 'F', color: '#e91e63' }, // Pink
                    { label: 'G', color: '#00bcd4' }, // Cyan
                    { label: 'H', color: '#795548' }, // Brown
                    { label: 'I', color: '#9e9e9e' }  // Grey
                ];
            }
            settings.shifts = defaultShifts.slice(0, numShiftsRequired);
        }

        function saveSettingsToLocalStorage(isInitialSave = false) {
            try {
                localStorage.setItem('fireShiftCalendarSettings', JSON.stringify(settings));
                if (!isInitialSave) showToast("Configurações salvas com sucesso!", "success");
                tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings)); 
                return true; 
            } catch (error) {
                console.error("Erro ao salvar configurações:", error);
                if (!isInitialSave) showToast("Erro ao salvar configurações.", "error");
                return false; 
            }
        }
        
        function saveEventsToLocalStorage() {
            try {
                localStorage.setItem('fireShiftEvents', JSON.stringify(events));
                localStorage.setItem('fireShiftRecurringEvents', JSON.stringify(recurringEvents));
            } catch (error) {
                console.error("Erro ao salvar eventos:", error);
                showToast("Erro ao salvar evento.", "error");
            }
        }
        
        function populateScheduleTypes() {  
            scheduleTypeSelect.innerHTML = ''; 
            Object.keys(schedulePatterns).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = schedulePatterns[key].name;
                scheduleTypeSelect.appendChild(option);
            });
        }

        function getShiftsForCalendarDay(dateToCalc) {
            const patternDetails = schedulePatterns[settings.scheduleType];
            if (!patternDetails || !settings.shifts || settings.shifts.length === 0) {
                return { dayShift: null, nightShift: null };
            }

            const [refYear, refMonth, refDay] = settings.referenceDate.split('-').map(Number);
            const refDateUtc = Date.UTC(refYear, refMonth - 1, refDay);
            const currentDateUtc = Date.UTC(dateToCalc.getFullYear(), dateToCalc.getMonth(), dateToCalc.getDate());
            const diffDays = Math.floor((currentDateUtc - refDateUtc) / (1000 * 60 * 60 * 24));

            if (patternDetails.isComplex12h) { 
                let patternMap = secomUrPatternMap;
                const cycleDay = (diffDays % patternDetails.daysInCycle + patternDetails.daysInCycle) % patternDetails.daysInCycle;
                const dayShiftTeamIndex = patternMap[cycleDay][0];
                const nightShiftTeamIndex = patternMap[cycleDay][1];
                return {
                    dayShift: settings.shifts[dayShiftTeamIndex] || null,
                    nightShift: settings.shifts[nightShiftTeamIndex] || null
                };
            } else { 
                const numDistinctTeams = patternDetails.shiftsInPattern; 
                const daysWork = patternDetails.daysOn; 
                if (numDistinctTeams === 0 || daysWork === 0) return { dayShift: null, nightShift: null };
                const fullRotationLength = numDistinctTeams * daysWork;
                if (fullRotationLength === 0) return { dayShift: null, nightShift: null};
                let dayInFullRotation = diffDays % fullRotationLength;
                if (dayInFullRotation < 0) {
                    dayInFullRotation += fullRotationLength;
                }
                const teamTurnIndex = Math.floor(dayInFullRotation / daysWork);
                if (settings.shifts[teamTurnIndex]) {
                    return { dayShift: settings.shifts[teamTurnIndex], nightShift: settings.shifts[teamTurnIndex] };
                }
                return { dayShift: null, nightShift: null }; 
            }
        }

        function lightenColor(hexColor, percent) {
            if (!hexColor || hexColor.length < 7) return '#FFFFFF';
            try {
                const num = parseInt(hexColor.slice(1), 16),
                    amt = Math.round(2.55 * percent),
                    R = (num >> 16) + amt,
                    G = ((num >> 8) & 0x00FF) + amt,
                    B = (num & 0x0000FF) + amt;
                return "#" + (0x1000000 + (R > 255 ? 255 : R < 0 ? 0 : R) * 0x10000 + (G > 255 ? 255 : G < 0 ? 0 : G) * 0x100 + (B > 255 ? 255 : B < 0 ? 0 : B)).toString(16).slice(1);
            } catch (e) {
                return '#FFFFFF';
            }
        }


        // Helper to create the "Todas as Alas" button
        function createShowAllButton() {
            const button = document.createElement('button');
            button.textContent = 'Todas as Alas';
            button.className = `btn-glossy text-sm ${settings.filteredShiftLabel === null ? 'blue' : 'grey'}`;
            if (settings.viewMode === 'mobile') {
                button.classList.add('py-1', 'px-2', 'text-xs');
            }
            button.onclick = () => {
                settings.filteredShiftLabel = null;
                saveSettingsToLocalStorage();
                applySettingsAndRender();
            };
            return button;
        }

        // Helper to create an individual Ala button
        function createAlaButton(shift) {
            const button = document.createElement('button');
            button.textContent = `Ala ${shift.label}`;
            button.className = 'btn-glossy text-sm';
            if (settings.viewMode === 'mobile') {
                button.classList.add('py-1', 'px-2', 'text-xs');
            }
            
            if (settings.filteredShiftLabel === shift.label) {
                button.style.background = `linear-gradient(to bottom, ${lightenColor(shift.color, 30)}, ${shift.color})`;
                button.style.color = getContrastColor(shift.color);
            } else {
                 button.classList.add('grey');
            }

            button.onclick = () => {
                settings.filteredShiftLabel = shift.label;
                saveSettingsToLocalStorage();
                applySettingsAndRender();
            };
            return button;
        }

        function renderShiftFilterButtons() {
            shiftFilterButtonsContainer.innerHTML = '';
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            if (!patternDetails || !settings.shifts || !settings.shifts.length) return;

            const isMobileAbcd = settings.scheduleType === 'ABCD_24_72' && settings.viewMode === 'mobile';

            // Alterado para 'justify-center' e 'flex-wrap'
            if (isMobileAbcd) {
                shiftFilterButtonsContainer.className = 'my-4 grid grid-cols-2 gap-3';
            } else {
                shiftFilterButtonsContainer.className = 'my-4 flex flex-wrap justify-center gap-3';
            }

            const showAllButton = createShowAllButton();
            if (isMobileAbcd) {
                showAllButton.classList.add('col-span-2');
            }
            shiftFilterButtonsContainer.appendChild(showAllButton);

            const sortedShifts = [...settings.shifts].sort((a, b) => a.label.localeCompare(b.label));

            sortedShifts.forEach((shift) => {
                shiftFilterButtonsContainer.appendChild(createAlaButton(shift));
            });
        }


        function renderCalendar() {  
            // Revertido para o layout com max-w-md no celular
            if (settings.viewMode === 'mobile') {
                mainCalendarContainer.classList.remove('max-w-3xl');
                mainCalendarContainer.classList.add('max-w-md'); 
                bodyElement.classList.add('p-4'); 
                currentMonthYear.classList.remove('text-xl');
                currentMonthYear.classList.add('text-lg');
            } else { 
                mainCalendarContainer.classList.remove('max-w-md');
                mainCalendarContainer.classList.add('max-w-3xl');
                bodyElement.classList.add('p-4');
                currentMonthYear.classList.remove('text-lg');
                currentMonthYear.classList.add('text-xl');
            }

            calendarGrid.innerHTML = ''; 
            calendarGrid.className = 'grid grid-cols-7 gap-1';
            currentMonthYear.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${currentDate.getFullYear()}`;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            loadHolidaysForYear(year); 

            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startingDay = firstDayOfMonth.getDay(); 
            if (settings.startDayOfWeek === 'Monday') startingDay = (startingDay === 0) ? 6 : startingDay - 1; 
            
            const dayHeadersBaseClasses = 'font-semibold text-center';
            const dayHeaders = (settings.startDayOfWeek === 'Monday') ? ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'] : ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            dayHeaders.forEach(header => {
                const dayHeaderCell = document.createElement('div');
                let headerClasses = dayHeadersBaseClasses;
                if (settings.viewMode === 'mobile') {
                    headerClasses += ' text-xs py-1 text-gray-500 dark:text-gray-400';
                } else {
                    headerClasses += ' text-sm py-2 text-gray-600 dark:text-gray-300';
                }
                dayHeaderCell.className = headerClasses;
                dayHeaderCell.textContent = header;
                calendarGrid.appendChild(dayHeaderCell);
            });

            for (let i = 0; i < startingDay; i++) calendarGrid.appendChild(document.createElement('div'));
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            const is12hPattern = patternDetails && (patternDetails.isComplex12h || patternDetails.isSimple12h);

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                // Removido 'aspect-square' e restaurado min-h
                let cellClasses = 'border-2 shadow-sm rounded-tr-2xl rounded-bl-2xl text-center flex flex-col justify-start items-center cursor-pointer overflow-hidden relative';
                if (settings.viewMode === 'mobile') {
                    cellClasses += ` ${is12hPattern ? 'p-0 min-h-[60px]' : 'p-1 min-h-[50px]'}`; 
                } else {
                    cellClasses += ` ${is12hPattern ? 'p-0 min-h-[80px]' : 'p-2 min-h-[70px]'}`; 
                }
                dayCell.className = cellClasses;

                const currentIterationDate = new Date(year, month, day);
                currentIterationDate.setHours(0, 0, 0, 0);
                
                if (currentIterationDate.getTime() === today.getTime()) {
                    dayCell.classList.add('animate-pulse', 'border-blue-700', 'dark:border-blue-500', 'border-b-4', 'shadow-lg', 'z-10');
                }

                const dayNumberSpan = document.createElement('span');
                // Restaurado o tamanho da fonte
                dayNumberSpan.className = `font-bold self-start z-10 ${settings.viewMode === 'mobile' ? 'text-sm p-1.5' : 'text-base p-2'}`;
                dayNumberSpan.textContent = day;
                
                const shiftsDisplayContainer = document.createElement('div');
                shiftsDisplayContainer.className = 'w-full flex flex-col justify-around items-center flex-grow';

                const actualShifts = getShiftsForCalendarDay(currentIterationDate); 

                let displayDayShift = null;
                let displayNightShift = null;

                if (settings.filteredShiftLabel) {
                    if (actualShifts.dayShift && actualShifts.dayShift.label === settings.filteredShiftLabel) displayDayShift = actualShifts.dayShift;
                    if (actualShifts.nightShift && actualShifts.nightShift.label === settings.filteredShiftLabel) displayNightShift = actualShifts.nightShift;
                } else { 
                    displayDayShift = actualShifts.dayShift;
                    displayNightShift = actualShifts.nightShift;
                }

                if (is12hPattern) {
                    dayCell.appendChild(dayNumberSpan); 
                    
                    const dayShiftDiv = document.createElement('div');
                    dayShiftDiv.className = `w-full text-center flex-1 flex items-center justify-center font-bold ${settings.viewMode === 'mobile' ? 'text-sm' : 'text-base'}`;
                    if (displayDayShift) {
                        const startColor = lightenColor(displayDayShift.color, 25);
                        dayShiftDiv.style.background = `linear-gradient(to bottom, ${startColor}, ${displayDayShift.color})`;
                        dayShiftDiv.style.color = getContrastColor(displayDayShift.color);
                        dayShiftDiv.textContent = displayDayShift.label + (settings.viewMode === 'desktop' ? ' (Dia)' : ' D');
                    } else {
                        dayShiftDiv.innerHTML = `&nbsp;`; 
                        if (settings.filteredShiftLabel) dayShiftDiv.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    shiftsDisplayContainer.appendChild(dayShiftDiv);

                    const nightShiftDiv = document.createElement('div');
                    nightShiftDiv.className = `w-full text-center flex-1 flex items-center justify-center font-bold ${settings.viewMode === 'mobile' ? 'text-sm' : 'text-base'}`;
                     if (displayNightShift) {
                        const startColor = lightenColor(displayNightShift.color, 25);
                        nightShiftDiv.style.background = `linear-gradient(to bottom, ${startColor}, ${displayNightShift.color})`;
                        nightShiftDiv.style.color = getContrastColor(displayNightShift.color);
                        nightShiftDiv.textContent = displayNightShift.label + (settings.viewMode === 'desktop' ? ' (Noite)' : ' N');
                    } else {
                        nightShiftDiv.innerHTML = `&nbsp;`;
                        if (settings.filteredShiftLabel) nightShiftDiv.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    shiftsDisplayContainer.appendChild(nightShiftDiv);
                    dayCell.appendChild(shiftsDisplayContainer);

                } else { 
                    dayCell.appendChild(dayNumberSpan);
                    if (displayDayShift) {
                        const startColor = lightenColor(displayDayShift.color, 25);
                        dayCell.style.background = `linear-gradient(to bottom, ${startColor}, ${displayDayShift.color})`;
                        const contrastColor = getContrastColor(displayDayShift.color);
                        dayNumberSpan.style.color = contrastColor; 
                        const shiftLabel = document.createElement('span');
                        shiftLabel.className = `font-bold flex-grow flex items-center justify-center ${settings.viewMode === 'mobile' ? 'text-lg' : 'text-xl'}`;
                        shiftLabel.style.color = contrastColor; 
                        shiftLabel.textContent = displayDayShift.label;
                        shiftsDisplayContainer.appendChild(shiftLabel);
                    } else {
                        dayNumberSpan.classList.add(settings.viewMode === 'mobile' ? 'text-gray-700' : 'text-gray-800', 'dark:text-gray-200');
                        if (settings.filteredShiftLabel) dayCell.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    dayCell.appendChild(shiftsDisplayContainer);
                }

                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const recurringDateKey = `${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                
                const indicatorsTopLeft = document.createElement('div');
                indicatorsTopLeft.className = 'absolute top-1 left-1 flex space-x-1 z-20';

                const indicatorsTopRight = document.createElement('div');
                indicatorsTopRight.className = 'absolute top-1 right-1 flex space-x-1 z-20';

                const indicatorsBottomLeft = document.createElement('div');
                indicatorsBottomLeft.className = 'absolute bottom-1 left-1 flex space-x-1 z-20';

                if (recurringEvents[recurringDateKey]) {
                    const anniversaryDot = document.createElement('div');
                    anniversaryDot.className = 'w-2 h-2 bg-yellow-400 rounded-full ring-1 ring-white dark:ring-black';
                    anniversaryDot.title = `Aniversário: ${recurringEvents[recurringDateKey]}`;
                    indicatorsTopLeft.appendChild(anniversaryDot);
                }

                if (holidays[year] && holidays[year][dateKey]) {
                    const holidayDot = document.createElement('div');
                    holidayDot.className = 'w-2 h-2 bg-red-500 rounded-full ring-1 ring-white dark:ring-black';
                    holidayDot.title = `Feriado: ${holidays[year][dateKey]}`;
                    indicatorsTopRight.appendChild(holidayDot);
                }

                if (events[dateKey]) { 
                    const eventDot = document.createElement('div');
                    eventDot.className = 'w-2 h-2 bg-blue-500 rounded-full ring-1 ring-white dark:ring-black';
                    eventDot.title = `Evento: ${events[dateKey]}`;
                    indicatorsBottomLeft.appendChild(eventDot);
                }
                
                dayCell.appendChild(indicatorsTopLeft);
                dayCell.appendChild(indicatorsTopRight);
                dayCell.appendChild(indicatorsBottomLeft);
                
                dayCell.addEventListener('click', () => openEventModal(currentIterationDate));
                calendarGrid.appendChild(dayCell);
            }

            holidayLegendContainer.innerHTML = ''; 
            const holidaysThisMonth = [];
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                if (holidays[year] && holidays[year][dateKey]) {
                    holidaysThisMonth.push({ day, name: holidays[year][dateKey] });
                }
            }

            if (holidaysThisMonth.length > 0) {
                holidaysThisMonth.forEach(holiday => {
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center space-x-2';
                    
                    const dot = document.createElement('div');
                    dot.className = 'w-2 h-2 bg-red-500 rounded-full flex-shrink-0';
                    
                    const text = document.createElement('span');
                    text.className = 'font-semibold';
                    const formattedDate = `${String(holiday.day).padStart(2, '0')}/${String(month + 1).padStart(2, '0')}`;
                    text.textContent = `${formattedDate} - ${holiday.name}`;

                    legendItem.appendChild(dot);
                    legendItem.appendChild(text);
                    holidayLegendContainer.appendChild(legendItem);
                });
            }
        }

        function openEventModal(date) {
            currentlyEditingEventDate = date;
            const dateKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            const recurringDateKey = `${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            
            eventModalTitle.textContent = `Evento para ${date.toLocaleDateString('pt-BR')}`;
            
            const recurringText = recurringEvents[recurringDateKey] || '';
            const eventText = events[dateKey] || '';
            eventDescriptionInput.value = [recurringText, eventText].filter(Boolean).join('\n');
            suggestionLoadingText.classList.add('hidden');
            eventDescriptionInput.classList.remove('hidden');

            eventModal.classList.remove('hidden');
        }

        closeEventModalButton.addEventListener('click', () => eventModal.classList.add('hidden'));

        saveEventButton.addEventListener('click', () => {
            if (currentlyEditingEventDate) {
                const dateKey = `${currentlyEditingEventDate.getFullYear()}-${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                const recurringDateKey = `${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                const descriptionLines = eventDescriptionInput.value.trim().split('\n');

                const niverLines = descriptionLines.filter(line => line.toLowerCase().includes('niver'));
                const eventLines = descriptionLines.filter(line => !line.toLowerCase().includes('niver'));

                if (niverLines.length > 0) {
                    recurringEvents[recurringDateKey] = niverLines.join('\n');
                } else {
                    delete recurringEvents[recurringDateKey];
                }

                if (eventLines.length > 0) {
                    events[dateKey] = eventLines.join('\n');
                } else {
                    delete events[dateKey];
                }

                showToast("Eventos salvos!", "success");
                saveEventsToLocalStorage();
                renderCalendar();
                eventModal.classList.add('hidden');
            }
        });

        deleteEventButton.addEventListener('click', () => {
            if (currentlyEditingEventDate) {
                const dateKey = `${currentlyEditingEventDate.getFullYear()}-${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                const recurringDateKey = `${String(currentlyEditingEventDate.getMonth() + 1).padStart(2, '0')}-${String(currentlyEditingEventDate.getDate()).padStart(2, '0')}`;
                
                let eventDeleted = false;
                if (events[dateKey]) {
                    delete events[dateKey];
                    eventDeleted = true;
                }
                if (recurringEvents[recurringDateKey]) {
                    delete recurringEvents[recurringDateKey];
                    eventDeleted = true;
                }

                if(eventDeleted) {
                    showToast("Evento deletado!", "info");
                    saveEventsToLocalStorage();
                    renderCalendar();
                }
                eventModal.classList.add('hidden');
            }
        });


        function getContrastColor(hexColor) { 
            if (!hexColor || hexColor.length < 7) return '#000000'; 
            try {
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#FFFFFF';
            } catch (e) {
                console.error("Erro ao parsear cor hexadecimal:", hexColor, e);
                return '#000000'; 
            }
        }

        function darkenColor(hexColor, percent) {
            if (!hexColor || hexColor.length < 7) return '#555555';
            try {
                const num = parseInt(hexColor.slice(1), 16),
                    amt = Math.round(2.55 * percent),
                    R = (num >> 16) - amt,
                    G = ((num >> 8) & 0x00FF) - amt,
                    B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            } catch (e) {
                console.error("Erro ao escurecer a cor:", hexColor, e);
                return '#555555'; // fallback
            }
        }

        function updateSettingsUIInputs() {  
            scheduleTypeSelect.value = settings.scheduleType;
            shiftContainer.innerHTML = ''; 
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            const numShiftsToDisplay = patternDetails ? patternDetails.shiftsInPattern : (settings.shifts ? settings.shifts.length : 0);
            
            if (!settings.shifts) settings.shifts = [];
            
            let currentDefaultShifts = [];
            if (settings.scheduleType === 'ABCD_24_72') {
                currentDefaultShifts = [
                    { label: 'A', color: '#FF0000' }, { label: 'B', color: '#00FF00' },
                    { label: 'C', color: '#FFA500' }, { label: 'D', color: '#FFFF00' }
                ];
            } else if (settings.scheduleType === 'SECOM_UR_12H') {
                currentDefaultShifts = [
                    { label: 'E', color: '#ff9800' }, { label: 'F', color: '#e91e63' },
                    { label: 'G', color: '#00bcd4' }, { label: 'H', color: '#795548' },
                    { label: 'I', color: '#9e9e9e' }
                ];
            }

            const finalShifts = [];
            for (let i = 0; i < numShiftsToDisplay; i++) {
                if (settings.shifts[i] && settings.shifts[i].label && settings.shifts[i].color) { 
                    finalShifts.push(settings.shifts[i]);
                } else if (currentDefaultShifts[i]) { 
                    finalShifts.push(currentDefaultShifts[i]);
                } else { 
                    finalShifts.push({ label: String.fromCharCode(65 + i), color: '#CCCCCC' });
                }
            }
            settings.shifts = finalShifts.slice(0, numShiftsToDisplay); 


            for (let i = 0; i < numShiftsToDisplay; i++) {
                const currentShiftConfig = settings.shifts[i]; 
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 mb-2';
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.value = currentShiftConfig.label;
                labelInput.maxLength = 3;
                labelInput.className = 'w-16 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white';
                labelInput.onchange = (e) => { settings.shifts[i].label = e.target.value; }; 
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = currentShiftConfig.color;
                colorInput.className = 'w-12 h-10 p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600';
                colorInput.disabled = false; 
                colorInput.title = "";
                colorInput.classList.remove('cursor-not-allowed', 'opacity-70');
                colorInput.onchange = (e) => { 
                    settings.shifts[i].color = e.target.value; 
                }; 
                
                const shiftTitle = document.createElement('span');
                shiftTitle.className = 'text-sm font-medium text-gray-700 dark:text-gray-300';
                shiftTitle.textContent = `Ala ${i + 1}:`; 
                div.appendChild(shiftTitle);
                div.appendChild(labelInput);
                div.appendChild(colorInput);
                shiftContainer.appendChild(div);
            }
        }
        
        toggleViewButton.addEventListener('click', () => {
            settings.viewMode = settings.viewMode === 'desktop' ? 'mobile' : 'desktop';
            saveSettingsToLocalStorage();
            applySettingsAndRender(); 
        });

        prevMonthButton.addEventListener('click', () => {  
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(); 
        });
        nextMonthButton.addEventListener('click', () => {  
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(); 
        });
        openSettingsButton.addEventListener('click', () => {  
            settings = JSON.parse(JSON.stringify(tempSettingsBeforeEdit)); 
            updateSettingsUIInputs(); 
            settingsModal.classList.remove('hidden');
        });
        closeSettingsButton.addEventListener('click', () => {  
            settingsModal.classList.add('hidden');
            settings = JSON.parse(JSON.stringify(tempSettingsBeforeEdit));
            applySettingsAndRender(); 
        });
        saveSettingsButton.addEventListener('click', async () => { 
            settings.scheduleType = scheduleTypeSelect.value;
            settings.filteredShiftLabel = null; 
            
            if (settings.scheduleType === 'SECOM_UR_12H') {
                settings.referenceDate = '2025-07-13';
            } else if (settings.scheduleType === 'ABCD_24_72') {
                settings.referenceDate = '2025-07-11';
            }

            const success = saveSettingsToLocalStorage(); 
            if (success) {
                settingsModal.classList.add('hidden');
                applySettingsAndRender(); 
            }
        });
        scheduleTypeSelect.addEventListener('change', (e) => {  
            const newScheduleType = e.target.value;
            settings.scheduleType = newScheduleType; 
            initializeDefaultShiftsForScheduleType(); 
            
            if (newScheduleType === 'SECOM_UR_12H') {
                settings.referenceDate = '2025-07-13';
            } else if (newScheduleType === 'ABCD_24_72') {
                settings.referenceDate = '2025-07-11';
            }
            
            settings.filteredShiftLabel = null; 
            updateSettingsUIInputs(); 
        });

        openTipsButton.addEventListener('click', () => tipsModal.classList.remove('hidden'));
        closeTipsModalButton.addEventListener('click', () => tipsModal.classList.add('hidden'));

        function showToast(message, type = 'info') {  
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = 'fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-xs z-[100] opacity-0 transition-opacity duration-500'; 
            if (type === 'success') toast.classList.add('bg-green-600');
            else if (type === 'error') toast.classList.add('bg-red-600');
            else toast.classList.add('bg-blue-600');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500); 
            }, 3000);
        }

        // Inicialização
        populateScheduleTypes();
        loadSettingsFromLocalStorage(); 
        loadEventsFromLocalStorage();
        applySettingsAndRender();

    </script>
    <style> 
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; visibility: hidden; }
        .btn-glossy {
            position: relative;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 600;
            color: white;
            text-shadow: 0 -1px 1px rgba(0,0,0,0.3);
            border: 1px solid rgba(0,0,0,0.4);
            box-shadow:
                inset 0 1px 1px rgba(255,255,255,0.4),
                0 4px 6px -1px rgba(0,0,0,0.3), 
                0 2px 4px -2px rgba(0,0,0,0.3);
            transition: all 0.15s ease-out;
            transform: translateZ(0); /* For GPU acceleration */
            overflow: hidden;
        }
        .btn-glossy::before {
            content: '';
            position: absolute;
            top: 1px;
            left: 5%;
            width: 90%;
            height: 50%;
            background: linear-gradient(to bottom, rgba(255,255,255,0.6), rgba(255,255,255,0.1));
            border-radius: 9999px;
            opacity: 0.8;
        }
        .btn-glossy:active {
            transform: translateY(2px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.4);
        }
        .btn-glossy.purple { background: linear-gradient(to bottom, #a855f7, #7e22ce); }
        .btn-glossy.green { background: linear-gradient(to bottom, #22c55e, #15803d); }
        .btn-glossy.blue { background: linear-gradient(to bottom, #3b82f6, #1d4ed8); }
        .btn-glossy.red { background: linear-gradient(to bottom, #ef4444, #b91c1c); }
        .btn-glossy.teal { background: linear-gradient(to bottom, #14b8a6, #0f766e); }
        .btn-glossy.grey { 
            background: linear-gradient(to bottom, #f5f5f5, #e0e0e0);
            color: #333;
            text-shadow: 0 1px 1px rgba(255,255,255,0.7);
        }

    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="mainCalendarContainer" class="w-full max-w-3xl mx-auto bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6">
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">Calendário de Escalas</h1>
        </div>
        <div class="flex justify-center items-center mb-4 space-x-3">
            <button id="toggleViewButton" class="btn-glossy purple text-sm">
                PC
            </button>
            <button id="openSettingsButton" class="btn-glossy blue text-sm">
                Config
            </button>
            <button id="openTipsButton" class="btn-glossy green text-sm">
                Dicas
            </button>
        </div>

        <div id="shiftFilterButtonsContainer" class="my-4 flex flex-wrap justify-center">
        </div>
        
        <div class="flex justify-between items-center mb-4">
            <button id="prevMonth" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
            </button>
            <div class="flex items-center space-x-2">
                <h2 id="currentMonthYear" class="text-xl font-semibold"></h2>
                <!-- Botão de IA Removido -->
            </div>
            <button id="nextMonth" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
            </button>
        </div>
        <!-- Container de Resumo Removido -->
        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>

        <!-- Legenda de Eventos e Feriados -->
        <div class="mt-4 flex flex-col justify-start items-start space-y-1 text-xs text-gray-600 dark:text-gray-400">
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-yellow-400 rounded-full"></div>
                <span class="font-semibold">Aniversário</span>
            </div>
            <div class="flex items-center space-x-2">
                <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                <span class="font-semibold">Dias com agenda</span>
            </div>
            <!-- Container para a legenda de feriados dinâmica -->
            <div id="holidayLegendContainer" class="flex flex-col items-start space-y-1">
                <!-- A legenda de feriados será inserida aqui pelo JavaScript -->
            </div>
        </div>

        <footer class="text-center mt-6">
            <div class="flex justify-center items-center space-x-2 text-xs text-gray-400 dark:text-gray-500">
                <span>By KleDer</span>
                <span>|</span>
                <a href="mailto:kgfontinelle@gmail.com" class="hover:text-blue-500">kgfontinelle@gmail.com</a>
            </div>
            <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">Versão 1.08</p>
        </footer>
    </div>

    <!-- Modal de Configurações da Escala -->
    <div id="settingsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Configurações da Escala</h3>
                <button id="closeSettingsButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="scheduleType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Escala:</label>
                    <select id="scheduleType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">Configuração das Alas:</h4>
                    <div id="shiftSettingsContainer" class="space-y-3"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-center">
                <button id="saveSettingsButton" class="btn-glossy green">
                    Salvar Configurações
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Eventos -->
    <div id="eventModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 id="eventModalTitle" class="text-xl font-semibold text-gray-800 dark:text-gray-100">Adicionar/Editar Evento</h3>
                <button id="closeEventModalButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div>
                <label for="eventDescriptionInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Descrição(ões) do Evento (use "niver" para aniversários; uma por linha):</label>
                <textarea id="eventDescriptionInput" placeholder="Ex: GSV&#10;Niver do João&#10;Consulta médica" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white" rows="3"></textarea>
            </div>
             <div class="mt-4 flex justify-end items-center">
                <div class="flex space-x-2">
                     <button id="deleteEventButton" class="btn-glossy red">
                        Deletar
                    </button>
                    <button id="saveEventButton" class="btn-glossy green">
                        Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Dicas -->
    <div id="tipsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Dicas de Uso</h3>
                <button id="closeTipsModalButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <ul class="space-y-3 text-gray-700 dark:text-gray-300 list-disc list-inside">
                <li>Para que os aniversários fiquem gravados para os anos subsequentes, escreva "niver" antes do nome da pessoa.</li>
                <li>Nas configurações, escolha qual escala quer ver e depois clique em "Salvar".</li>
                <li>Caso queira modificar as cores ou as legendas das alas, fique à vontade na tela de configurações.</li>
                <li>Clique em qualquer dia para adicionar um evento pessoal.</li>
            </ul>
        </div>
    </div>

    <!-- Modal de Seleção de Ala para Resumo (Removido) -->

    <div id="toastNotification" class="hidden fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-xs z-[100] opacity-0" role="alert">
        <span id="toastMessage"></span>
    </div>
</body>
</html>