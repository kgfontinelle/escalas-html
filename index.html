<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendário de Escalas de Serviço</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script type="module">
        // Elementos da UI
        const calendarGrid = document.getElementById('calendarGrid');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthButton = document.getElementById('prevMonth');
        const nextMonthButton = document.getElementById('nextMonth');
        const settingsModal = document.getElementById('settingsModal');
        const openSettingsButton = document.getElementById('openSettingsButton');
        const closeSettingsButton = document.getElementById('closeSettingsButton');
        const saveSettingsButton = document.getElementById('saveSettingsButton');
        const scheduleTypeSelect = document.getElementById('scheduleType');
        const referenceDateInput = document.getElementById('referenceDate');
        const startDayOfWeekSelect = document.getElementById('startDayOfWeek');
        const shiftContainer = document.getElementById('shiftSettingsContainer');
        const toggleViewButton = document.getElementById('toggleViewButton'); 
        const mainCalendarContainer = document.getElementById('mainCalendarContainer'); 
        const shiftFilterButtonsContainer = document.getElementById('shiftFilterButtonsContainer'); 
        
        // Elementos para a funcionalidade Gemini
        const suggestActivityButton = document.getElementById('suggestActivityButton');
        const activitySuggestionArea = document.getElementById('activitySuggestionArea');
        const selectedDayInfo = document.getElementById('selectedDayInfo');

        let currentDate = new Date(2025, 5, 1); 
        let settings = {
            scheduleType: 'ABCD_24_72', 
            referenceDate: '2025-06-01', 
            startDayOfWeek: 'Sunday',    
            shifts: [ 
                { label: 'A', color: '#FF0000' }, 
                { label: 'B', color: '#00FF00' }, 
                { label: 'C', color: '#0000FF' }, 
                { label: 'D', color: '#FFFF00' }  
            ],
            viewMode: 'desktop',
            filteredShiftLabel: null 
        };
        let tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings));
        let selectedOffDayDate = null; 

        const schedulePatterns = {
            'ABCD_24_72': { name: 'ABCD (24/72 - 1 dia trab / 3 folga)', shiftsInPattern: 4, daysOn: 1, daysOff: 3 },
            'CUSTOM_5TEAM_12H_DN': { name: '5 Alas - Ciclo D/N (12h)', shiftsInPattern: 5, isComplex12h: true, daysInCycle: 5 },
            '5TEAM_12_48': { name: '5 Alas - Turnos 12h (12/48)', shiftsInPattern: 5, isSimple12h: true, daysInCycle: 2.5 }, 
            'ABC_24_48': { name: 'ABC (24/48 - 1 dia trab / 2 folga)', shiftsInPattern: 3, daysOn: 1, daysOff: 2 },
            'AABBCC_48_96': { name: 'AABBCC (48/96 - 2 dias trab / 4 folga)', shiftsInPattern: 3, daysOn: 2, daysOff: 4 },
        };

        const custom5TeamPatternMap = [
            [0, 4], [1, 0], [2, 1], [3, 2], [4, 3]  
        ];

        function updateToggleButtonText() {
            toggleViewButton.textContent = settings.viewMode === 'desktop' ? 'Visualização Celular' : 'Visualização PC';
        }

        function applySettingsAndRender() { 
            updateSettingsUIInputs(); 
            updateToggleButtonText(); 
            renderShiftFilterButtons(); 
            renderCalendar(); 
        }

        function loadSettingsFromLocalStorage() {
            console.log("Tentando carregar configurações do LocalStorage.");
            const storedSettings = localStorage.getItem('fireShiftCalendarSettings');
            if (storedSettings) {
                try {
                    const loadedSettings = JSON.parse(storedSettings);
                    console.log("Configurações carregadas do LocalStorage:", loadedSettings);
                    
                    settings.scheduleType = loadedSettings.scheduleType !== undefined ? loadedSettings.scheduleType : settings.scheduleType;
                    settings.referenceDate = loadedSettings.referenceDate !== undefined ? loadedSettings.referenceDate : settings.referenceDate;
                    settings.startDayOfWeek = loadedSettings.startDayOfWeek !== undefined ? loadedSettings.startDayOfWeek : settings.startDayOfWeek;
                    settings.viewMode = loadedSettings.viewMode !== undefined ? loadedSettings.viewMode : 'desktop'; 
                    settings.filteredShiftLabel = loadedSettings.filteredShiftLabel !== undefined ? loadedSettings.filteredShiftLabel : null; 
                    
                    const patternDetails = schedulePatterns[settings.scheduleType]; 
                    const numShiftsRequired = patternDetails ? patternDetails.shiftsInPattern : 4; 

                    if (loadedSettings.shifts && Array.isArray(loadedSettings.shifts) && loadedSettings.shifts.length >= numShiftsRequired) {
                        settings.shifts = loadedSettings.shifts.slice(0, numShiftsRequired).map((s, i) => ({
                            label: s.label || String.fromCharCode(65 + i),
                            color: s.color || '#CCCCCC'
                        }));
                    } else { 
                        initializeDefaultShiftsForScheduleType();
                    }

                } catch (e) {
                    console.error("Erro ao parsear configurações do LocalStorage, usando padrões:", e);
                    initializeDefaultSettings(); 
                    saveSettingsToLocalStorage(true);
                }
            } else {
                console.log("Nenhuma configuração encontrada no LocalStorage. Usando padrões e salvando.");
                initializeDefaultSettings(); 
                saveSettingsToLocalStorage(true); 
            }
            tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings)); 
            applySettingsAndRender();
        }
        
        function initializeDefaultSettings() {
            settings.scheduleType = 'ABCD_24_72';
            settings.referenceDate = '2025-06-01';
            settings.startDayOfWeek = 'Sunday';
            settings.viewMode = 'desktop';
            settings.filteredShiftLabel = null;
            initializeDefaultShiftsForScheduleType();
        }

        function initializeDefaultShiftsForScheduleType() {
            const patternDetails = schedulePatterns[settings.scheduleType];
            const numShiftsRequired = patternDetails ? patternDetails.shiftsInPattern : 4;
            let defaultShifts = [];
            if (settings.scheduleType === 'ABCD_24_72') {
                defaultShifts = [
                    { label: 'A', color: '#FF0000' }, { label: 'B', color: '#00FF00' },
                    { label: 'C', color: '#0000FF' }, { label: 'D', color: '#FFFF00' }
                ];
            } else if (settings.scheduleType === 'CUSTOM_5TEAM_12H_DN') {
                defaultShifts = [
                    { label: 'G', color: '#FF0000' }, { label: 'H', color: '#00FF00' },
                    { label: 'I', color: '#0000FF' }, { label: 'J', color: '#FFFF00' },
                    { label: 'F', color: '#800080' }
                ];
            } else {
                 for (let i = 0; i < numShiftsRequired; i++) {
                    defaultShifts.push({ label: String.fromCharCode(65 + i), color: '#CCCCCC' });
                 }
            }
            settings.shifts = defaultShifts.slice(0, numShiftsRequired);
        }


        function saveSettingsToLocalStorage(isInitialSave = false) {
            console.log("Salvando configurações no LocalStorage:", settings);
            try {
                const currentPatternDetails = schedulePatterns[settings.scheduleType];
                if (currentPatternDetails) { 
                    const numShiftsRequired = currentPatternDetails.shiftsInPattern;
                    if (!settings.shifts) settings.shifts = [];
                    while (settings.shifts.length < numShiftsRequired) {
                        let defaultLabel = String.fromCharCode(65 + settings.shifts.length);
                        if (settings.scheduleType === 'CUSTOM_5TEAM_12H_DN' && settings.shifts.length < 5) {
                             const defaultLabels5Team = ['G', 'H', 'I', 'J', 'F'];
                             const defaultColors5Team = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#800080'];
                             defaultLabel = defaultLabels5Team[settings.shifts.length];
                             settings.shifts.push({ label: defaultLabel, color: defaultColors5Team[settings.shifts.length] });
                             continue;
                        }
                        settings.shifts.push({ label: defaultLabel, color: '#CCCCCC' });
                    }
                    if (settings.shifts.length > numShiftsRequired) {
                        settings.shifts.splice(numShiftsRequired);
                    }
                }

                localStorage.setItem('fireShiftCalendarSettings', JSON.stringify(settings));
                console.log("Configurações salvas com sucesso no LocalStorage!");
                if (!isInitialSave) showToast("Configurações salvas com sucesso!", "success");
                tempSettingsBeforeEdit = JSON.parse(JSON.stringify(settings)); 
                return true; 
            } catch (error) {
                console.error("Erro ao salvar configurações no LocalStorage:", error);
                if (!isInitialSave) showToast("Erro ao salvar configurações. O LocalStorage pode estar cheio ou desabilitado.", "error");
                return false; 
            }
        }
        
        function populateScheduleTypes() {  
            scheduleTypeSelect.innerHTML = ''; 
            Object.keys(schedulePatterns).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = schedulePatterns[key].name;
                scheduleTypeSelect.appendChild(option);
            });
        }

        function getShiftsForCalendarDay(dateToCalc) {
            const patternDetails = schedulePatterns[settings.scheduleType];
            if (!patternDetails || !settings.shifts || settings.shifts.length === 0) {
                return { dayShift: null, nightShift: null };
            }

            const [refYear, refMonth, refDay] = settings.referenceDate.split('-').map(Number);
            const refDateUtc = Date.UTC(refYear, refMonth - 1, refDay);
            const currentDateUtc = Date.UTC(dateToCalc.getFullYear(), dateToCalc.getMonth(), dateToCalc.getDate());
            const diffDays = Math.floor((currentDateUtc - refDateUtc) / (1000 * 60 * 60 * 24));

            if (patternDetails.isComplex12h) { 
                const cycleDay = (diffDays % patternDetails.daysInCycle + patternDetails.daysInCycle) % patternDetails.daysInCycle;
                const dayShiftTeamIndex = custom5TeamPatternMap[cycleDay][0];
                const nightShiftTeamIndex = custom5TeamPatternMap[cycleDay][1];
                return {
                    dayShift: settings.shifts[dayShiftTeamIndex] || null,
                    nightShift: settings.shifts[nightShiftTeamIndex] || null
                };
            } else if (patternDetails.isSimple12h) { 
                const numTeams = patternDetails.shiftsInPattern;
                const daySlotIndex = diffDays * 2;
                const nightSlotIndex = diffDays * 2 + 1;

                return {
                    dayShift: settings.shifts[daySlotIndex % numTeams] || null,
                    nightShift: settings.shifts[nightSlotIndex % numTeams] || null
                };
            } else { // Padrões 24h (e.g., ABCD_24_72, ABC_24_48, AABBCC_48_96) - LÓGICA CORRIGIDA
                const numDistinctTeams = patternDetails.shiftsInPattern; 
                const daysWork = patternDetails.daysOn; 

                if (numDistinctTeams === 0 || daysWork === 0) return { dayShift: null, nightShift: null };

                // Total de dias para uma rotação completa de todas as alas através de seus blocos de trabalho.
                // Ex: ABCD (24/72) -> 4 alas * 1 dia de trabalho = 4 dias.
                // Ex: AABBCC (48/96) -> 3 alas * 2 dias de trabalho = 6 dias.
                const fullRotationLength = numDistinctTeams * daysWork;

                if (fullRotationLength === 0) return { dayShift: null, nightShift: null};

                let dayInFullRotation = diffDays % fullRotationLength;
                if (dayInFullRotation < 0) {
                    dayInFullRotation += fullRotationLength;
                }

                // Determina qual ala está no seu período de trabalho.
                // Ex: ABCD, dayInFullRotation=0, daysWork=1 -> teamTurnIndex=0 (Ala A)
                // Ex: ABCD, dayInFullRotation=3, daysWork=1 -> teamTurnIndex=3 (Ala D)
                // Ex: AABBCC, dayInFullRotation=0, daysWork=2 -> teamTurnIndex=0 (Ala A, dia 1)
                // Ex: AABBCC, dayInFullRotation=1, daysWork=2 -> teamTurnIndex=0 (Ala A, dia 2)
                // Ex: AABBCC, dayInFullRotation=2, daysWork=2 -> teamTurnIndex=1 (Ala B, dia 1)
                const teamTurnIndex = Math.floor(dayInFullRotation / daysWork);

                if (settings.shifts[teamTurnIndex]) {
                    return { dayShift: settings.shifts[teamTurnIndex], nightShift: settings.shifts[teamTurnIndex] };
                }
                return { dayShift: null, nightShift: null }; 
            }
        }


        function renderShiftFilterButtons() {
            shiftFilterButtonsContainer.innerHTML = ''; 
            const patternDetails = schedulePatterns[settings.scheduleType];
            if (!patternDetails || !settings.shifts || settings.shifts.length === 0) return;

            const baseButtonClasses = 'py-1 px-3 rounded-md shadow text-xs transition-colors mr-2 mb-2 font-medium';
            
            const showAllButton = document.createElement('button');
            showAllButton.textContent = 'Todas as Alas';
            showAllButton.className = `${baseButtonClasses} ${settings.filteredShiftLabel === null ? 'bg-blue-600 text-white' : 'bg-gray-200 hover:bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600'}`;
            showAllButton.onclick = () => {
                settings.filteredShiftLabel = null;
                saveSettingsToLocalStorage();
                applySettingsAndRender();
            };
            shiftFilterButtonsContainer.appendChild(showAllButton);
            
            settings.shifts.forEach(shift => {
                const button = document.createElement('button');
                button.textContent = `Ala ${shift.label}`;
                button.style.backgroundColor = settings.filteredShiftLabel === shift.label ? shift.color : '';
                button.style.color = settings.filteredShiftLabel === shift.label ? getContrastColor(shift.color) : '';
                
                let dynamicClasses = settings.filteredShiftLabel === shift.label 
                    ? `border-2 border-black dark:border-white` 
                    : `bg-gray-200 hover:bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600`;
                if(settings.filteredShiftLabel !== shift.label){ 
                    button.style.borderColor = shift.color;
                    button.style.borderWidth = '2px';
                    button.style.color = shift.color; 
                    dynamicClasses = `bg-transparent hover:bg-opacity-20 hover:bg-[${shift.color}]`;
                }

                button.className = `${baseButtonClasses} ${dynamicClasses}`;
                button.onclick = () => {
                    settings.filteredShiftLabel = shift.label;
                    saveSettingsToLocalStorage();
                    applySettingsAndRender();
                };
                shiftFilterButtonsContainer.appendChild(button);
            });
        }


        function renderCalendar() {  
            if (settings.viewMode === 'mobile') {
                mainCalendarContainer.classList.remove('max-w-3xl');
                mainCalendarContainer.classList.add('max-w-md'); 
                currentMonthYear.classList.remove('text-xl');
                currentMonthYear.classList.add('text-lg');
            } else { 
                mainCalendarContainer.classList.remove('max-w-md');
                mainCalendarContainer.classList.add('max-w-3xl');
                currentMonthYear.classList.remove('text-lg');
                currentMonthYear.classList.add('text-xl');
            }

            calendarGrid.innerHTML = ''; 
            currentMonthYear.textContent = `${currentDate.toLocaleString('pt-BR', { month: 'long' })} ${currentDate.getFullYear()}`;
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            let startingDay = firstDayOfMonth.getDay(); 
            if (settings.startDayOfWeek === 'Monday') startingDay = (startingDay === 0) ? 6 : startingDay - 1; 
            
            const dayHeadersBaseClasses = 'font-semibold text-center';
            const dayHeaders = (settings.startDayOfWeek === 'Monday') ? ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'] : ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
            
            selectedOffDayDate = null;
            suggestActivityButton.classList.add('hidden');
            activitySuggestionArea.innerHTML = '';
            activitySuggestionArea.classList.add('hidden');
            selectedDayInfo.textContent = '';
            selectedDayInfo.classList.add('hidden');

            dayHeaders.forEach(header => {
                const dayHeaderCell = document.createElement('div');
                let headerClasses = dayHeadersBaseClasses;
                if (settings.viewMode === 'mobile') {
                    headerClasses += ' text-xs py-1 text-gray-500 dark:text-gray-400';
                } else {
                    headerClasses += ' text-sm py-2 text-gray-600 dark:text-gray-300';
                }
                dayHeaderCell.className = headerClasses;
                dayHeaderCell.textContent = header;
                calendarGrid.appendChild(dayHeaderCell);
            });

            for (let i = 0; i < startingDay; i++) calendarGrid.appendChild(document.createElement('div'));
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            const is12hPattern = patternDetails && (patternDetails.isComplex12h || patternDetails.isSimple12h);

            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                let cellClasses = 'border rounded-md text-center hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors flex flex-col justify-between items-center cursor-pointer overflow-hidden';
                if (settings.viewMode === 'mobile') {
                    cellClasses += ` ${is12hPattern ? 'p-0 min-h-[60px]' : 'p-1 min-h-[50px]'}`; 
                } else {
                    cellClasses += ` ${is12hPattern ? 'p-0 min-h-[80px]' : 'p-2 min-h-[70px]'}`; 
                }
                dayCell.className = cellClasses;

                const dayNumberSpan = document.createElement('span');
                dayNumberSpan.className = `font-medium self-start ${settings.viewMode === 'mobile' ? 'text-xs px-1 pt-0.5' : 'text-sm px-2 pt-1'}`;
                dayNumberSpan.textContent = day;
                
                const shiftsDisplayContainer = document.createElement('div');
                shiftsDisplayContainer.className = 'w-full flex flex-col justify-around items-center flex-grow';

                const currentIterationDate = new Date(year, month, day);
                const actualShifts = getShiftsForCalendarDay(currentIterationDate); 

                let displayDayShift = null;
                let displayNightShift = null;
                let isDayOffForFilteredShift = false;

                if (settings.filteredShiftLabel) {
                    if (actualShifts.dayShift && actualShifts.dayShift.label === settings.filteredShiftLabel) {
                        displayDayShift = actualShifts.dayShift;
                    }
                    if (actualShifts.nightShift && actualShifts.nightShift.label === settings.filteredShiftLabel) {
                        displayNightShift = actualShifts.nightShift;
                    }
                    isDayOffForFilteredShift = !displayDayShift && !displayNightShift;
                } else { 
                    displayDayShift = actualShifts.dayShift;
                    displayNightShift = actualShifts.nightShift;
                }


                if (is12hPattern) {
                    dayCell.appendChild(dayNumberSpan); 
                    
                    const dayShiftDiv = document.createElement('div');
                    dayShiftDiv.className = `w-full text-center flex-1 flex items-center justify-center ${settings.viewMode === 'mobile' ? 'text-[10px]' : 'text-xs'}`;
                    if (displayDayShift) {
                        dayShiftDiv.style.backgroundColor = displayDayShift.color;
                        dayShiftDiv.style.color = getContrastColor(displayDayShift.color);
                        dayShiftDiv.textContent = displayDayShift.label + (settings.viewMode === 'desktop' ? ' (Dia)' : ' D');
                    } else {
                        dayShiftDiv.innerHTML = `&nbsp;`; 
                        if (settings.filteredShiftLabel) dayShiftDiv.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    shiftsDisplayContainer.appendChild(dayShiftDiv);

                    const nightShiftDiv = document.createElement('div');
                    nightShiftDiv.className = `w-full text-center flex-1 flex items-center justify-center ${settings.viewMode === 'mobile' ? 'text-[10px]' : 'text-xs'}`;
                     if (displayNightShift) {
                        nightShiftDiv.style.backgroundColor = displayNightShift.color;
                        nightShiftDiv.style.color = getContrastColor(displayNightShift.color);
                        nightShiftDiv.textContent = displayNightShift.label + (settings.viewMode === 'desktop' ? ' (Noite)' : ' N');
                    } else {
                        nightShiftDiv.innerHTML = `&nbsp;`;
                        if (settings.filteredShiftLabel) nightShiftDiv.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    shiftsDisplayContainer.appendChild(nightShiftDiv);
                    dayCell.appendChild(shiftsDisplayContainer);

                } else { 
                    dayCell.appendChild(dayNumberSpan);
                    if (displayDayShift) { 
                        dayCell.style.backgroundColor = displayDayShift.color;
                        const contrastColor = getContrastColor(displayDayShift.color);
                        dayNumberSpan.style.color = contrastColor; 
                        const shiftLabel = document.createElement('span');
                        shiftLabel.className = `font-bold flex-grow flex items-center justify-center ${settings.viewMode === 'mobile' ? 'text-[10px] mt-0.5' : 'text-xs mt-1'}`;
                        shiftLabel.style.color = contrastColor; 
                        shiftLabel.textContent = displayDayShift.label;
                        shiftsDisplayContainer.appendChild(shiftLabel);
                    } else {
                        if (settings.viewMode === 'mobile') {
                            dayNumberSpan.classList.add('text-gray-700');
                            dayNumberSpan.classList.add('dark:text-gray-200');
                        } else {
                            dayNumberSpan.classList.add('text-gray-800');
                            dayNumberSpan.classList.add('dark:text-gray-100');
                        }
                        if (settings.filteredShiftLabel) dayCell.classList.add('bg-gray-50', 'dark:bg-gray-800'); 
                    }
                    dayCell.appendChild(shiftsDisplayContainer);
                }
                
                if (settings.filteredShiftLabel && isDayOffForFilteredShift) {
                    if (!is12hPattern || (is12hPattern && !displayDayShift && !displayNightShift)) { 
                        dayCell.addEventListener('click', () => {
                            clearOffDaySelection(); 
                            dayCell.classList.add('ring-2', 'ring-teal-500', 'dark:ring-teal-400');
                            selectedOffDayDate = currentIterationDate;
                            selectedDayInfo.textContent = `Folga da Ala ${settings.filteredShiftLabel} em: ${selectedOffDayDate.toLocaleDateString('pt-BR')}`;
                            selectedDayInfo.classList.remove('hidden');
                            suggestActivityButton.classList.remove('hidden');
                            activitySuggestionArea.classList.add('hidden'); 
                            activitySuggestionArea.innerHTML = ''; 
                        });
                    }
                } else if (!settings.filteredShiftLabel && !actualShifts.dayShift && !actualShifts.nightShift) { 
                     dayCell.addEventListener('click', () => {
                        clearOffDaySelection();
                        showToast("Selecione uma ala para ver sugestões de atividades para os dias de folga dela.", "info");
                     });
                } else { 
                     dayCell.addEventListener('click', () => clearOffDaySelection());
                }
                calendarGrid.appendChild(dayCell);
            }
        }

        function clearOffDaySelection() {
            const currentlySelected = calendarGrid.querySelector('.ring-2');
            if (currentlySelected) {
                currentlySelected.classList.remove('ring-2', 'ring-teal-500', 'dark:ring-teal-400');
            }
            selectedOffDayDate = null;
            suggestActivityButton.classList.add('hidden');
            activitySuggestionArea.classList.add('hidden');
            activitySuggestionArea.innerHTML = '';
            selectedDayInfo.classList.add('hidden');
            selectedDayInfo.textContent = '';
        }

        function getContrastColor(hexColor) { 
            if (!hexColor || hexColor.length < 7) return '#000000'; 
            try {
                const r = parseInt(hexColor.slice(1, 3), 16);
                const g = parseInt(hexColor.slice(3, 5), 16);
                const b = parseInt(hexColor.slice(5, 7), 16);
                const yiq = ((r * 299) + (g * 587) + (b * 114)) / 1000;
                return (yiq >= 128) ? '#000000' : '#FFFFFF';
            } catch (e) {
                console.error("Erro ao parsear cor hexadecimal:", hexColor, e);
                return '#000000'; 
            }
        }
        function updateSettingsUIInputs() {  
            scheduleTypeSelect.value = settings.scheduleType;
            referenceDateInput.value = settings.referenceDate;
            startDayOfWeekSelect.value = settings.startDayOfWeek;
            shiftContainer.innerHTML = ''; 
            
            const patternDetails = schedulePatterns[settings.scheduleType];
            const numShiftsToDisplay = patternDetails ? patternDetails.shiftsInPattern : (settings.shifts ? settings.shifts.length : 0);
            
            if (!settings.shifts) settings.shifts = [];
            
            let currentDefaultShifts = [];
            if (settings.scheduleType === 'ABCD_24_72') {
                currentDefaultShifts = [
                    { label: 'A', color: '#FF0000' }, { label: 'B', color: '#00FF00' },
                    { label: 'C', color: '#0000FF' }, { label: 'D', color: '#FFFF00' }
                ];
            } else if (settings.scheduleType === 'CUSTOM_5TEAM_12H_DN') {
                currentDefaultShifts = [
                    { label: 'G', color: '#FF0000' }, { label: 'H', color: '#00FF00' },
                    { label: 'I', color: '#0000FF' }, { label: 'J', color: '#FFFF00' },
                    { label: 'F', color: '#800080' }
                ];
            } else { 
                for (let i = 0; i < numShiftsToDisplay; i++) {
                    currentDefaultShifts.push({ label: String.fromCharCode(65 + i), color: '#CCCCCC' });
                }
            }

            const finalShifts = [];
            for (let i = 0; i < numShiftsToDisplay; i++) {
                if (settings.shifts[i] && settings.shifts[i].label && settings.shifts[i].color) { 
                    finalShifts.push(settings.shifts[i]);
                } else if (currentDefaultShifts[i]) { 
                    finalShifts.push(currentDefaultShifts[i]);
                } else { 
                    finalShifts.push({ label: String.fromCharCode(65 + i), color: '#CCCCCC' });
                }
            }
            settings.shifts = finalShifts.slice(0, numShiftsToDisplay); 


            for (let i = 0; i < numShiftsToDisplay; i++) {
                const currentShiftConfig = settings.shifts[i]; 
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2 mb-2';
                const labelInput = document.createElement('input');
                labelInput.type = 'text';
                labelInput.value = currentShiftConfig.label;
                labelInput.maxLength = 3;
                labelInput.className = 'w-16 p-2 border rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white';
                labelInput.onchange = (e) => { settings.shifts[i].label = e.target.value; }; 
                
                const colorInput = document.createElement('input');
                colorInput.type = 'color';
                colorInput.value = currentShiftConfig.color;
                colorInput.className = 'w-12 h-10 p-1 border rounded-md dark:bg-gray-700 dark:border-gray-600';
                colorInput.disabled = false; 
                colorInput.title = "";
                colorInput.classList.remove('cursor-not-allowed', 'opacity-70');
                colorInput.onchange = (e) => { 
                    settings.shifts[i].color = e.target.value; 
                }; 
                
                const shiftTitle = document.createElement('span');
                shiftTitle.className = 'text-sm font-medium text-gray-700 dark:text-gray-300';
                shiftTitle.textContent = `Ala ${i + 1}:`; 
                div.appendChild(shiftTitle);
                div.appendChild(labelInput);
                div.appendChild(colorInput);
                shiftContainer.appendChild(div);
            }
        }
        
        toggleViewButton.addEventListener('click', () => {
            settings.viewMode = settings.viewMode === 'desktop' ? 'mobile' : 'desktop';
            saveSettingsToLocalStorage();
            applySettingsAndRender(); 
        });

        prevMonthButton.addEventListener('click', () => {  
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(); 
        });
        nextMonthButton.addEventListener('click', () => {  
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(); 
        });
        openSettingsButton.addEventListener('click', () => {  
            settings = JSON.parse(JSON.stringify(tempSettingsBeforeEdit)); 
            updateSettingsUIInputs(); 
            settingsModal.classList.remove('hidden');
        });
        closeSettingsButton.addEventListener('click', () => {  
            settingsModal.classList.add('hidden');
            settings = JSON.parse(JSON.stringify(tempSettingsBeforeEdit));
            applySettingsAndRender(); 
        });
        saveSettingsButton.addEventListener('click', async () => { 
            settings.scheduleType = scheduleTypeSelect.value;
            settings.referenceDate = referenceDateInput.value;
            settings.startDayOfWeek = startDayOfWeekSelect.value;
            
            const success = saveSettingsToLocalStorage(); 
            if (success) {
                settingsModal.classList.add('hidden');
                applySettingsAndRender(); 
            }
        });
        scheduleTypeSelect.addEventListener('change', (e) => {  
            const newScheduleType = e.target.value;
            settings.scheduleType = newScheduleType; 
            initializeDefaultShiftsForScheduleType(); 
            settings.filteredShiftLabel = null; 
            updateSettingsUIInputs(); 
        });

        function showToast(message, type = 'info') {  
            const toast = document.getElementById('toastNotification');
            const toastMessage = document.getElementById('toastMessage');
            toastMessage.textContent = message;
            toast.className = 'fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-xs z-[100] opacity-0 transition-opacity duration-500'; 
            if (type === 'success') toast.classList.add('bg-green-600');
            else if (type === 'error') toast.classList.add('bg-red-600');
            else toast.classList.add('bg-blue-600');
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 500); 
            }, 3000);
        }

        // Funcionalidade Gemini
        suggestActivityButton.addEventListener('click', async () => {
            if (!selectedOffDayDate) {
                showToast("Por favor, selecione um dia de folga no calendário primeiro.", "info");
                return;
            }
             if (!settings.filteredShiftLabel) {
                showToast("Por favor, filtre por uma ala para obter sugestões de folga.", "info");
                return;
            }

            activitySuggestionArea.classList.remove('hidden');
            activitySuggestionArea.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 animate-pulse">Buscando sugestões... ✨</p>';

            const formattedDate = selectedOffDayDate.toLocaleDateString('pt-BR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const prompt = `Sou um bombeiro da Ala ${settings.filteredShiftLabel} e estou de folga no dia ${formattedDate}. Por favor, sugira 3 atividades de lazer ou para fazer com a família, adequadas para um dia de descanso. Formate como uma lista com marcadores.`;

            try {
                let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`; 

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error("Erro da API Gemini:", errorData);
                    if (response.status === 400 && errorData.error && errorData.error.message.toLowerCase().includes("api key not valid")) {
                         activitySuggestionArea.innerHTML = '<p class="text-red-500">Erro: A chave de API para o serviço de sugestões não é válida ou não foi fornecida. Esta funcionalidade pode não estar disponível.</p>';
                    } else {
                        activitySuggestionArea.innerHTML = `<p class="text-red-500">Erro da API: ${errorData.error?.message || response.statusText}</p>`;
                    }
                    throw new Error(`Erro da API: ${errorData.error?.message || response.statusText}`);
                }

                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    const formattedText = text.replace(/\*/g, '•').replace(/\n/g, '<br>');
                    activitySuggestionArea.innerHTML = `<h4 class="font-semibold mb-2 text-lg text-blue-600 dark:text-blue-400">Sugestões para ${formattedDate} (Ala ${settings.filteredShiftLabel}):</h4><div class="prose prose-sm dark:prose-invert max-w-none">${formattedText}</div>`;
                } else {
                    console.error("Resposta inesperada da API Gemini:", result);
                    activitySuggestionArea.innerHTML = '<p class="text-red-500">Não foi possível obter sugestões no momento. Tente novamente mais tarde.</p>';
                }

            } catch (error) {
                console.error("Erro ao buscar sugestões da API Gemini:", error);
                if (!activitySuggestionArea.innerHTML.includes("Erro: A chave de API")) { 
                   activitySuggestionArea.innerHTML = `<p class="text-red-500">Ocorreu um erro ao buscar sugestões: ${error.message}. Verifique o console para mais detalhes.</p>`;
                }
            }
        });

        // Inicialização
        populateScheduleTypes();
        loadSettingsFromLocalStorage(); 

    </script>
    <style> 
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .modal { transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out; }
        .modal.hidden { opacity: 0; visibility: hidden; }
        .prose ul { list-style-type: disc; padding-left: 1.5em;}
        .prose li { margin-bottom: 0.5em;}
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 p-4 min-h-screen flex flex-col items-center">

    <div id="mainCalendarContainer" class="w-full max-w-3xl mx-auto bg-white dark:bg-gray-800 shadow-xl rounded-lg p-6">
        <div class="text-center mb-4">
            <h1 class="text-2xl font-bold text-blue-600 dark:text-blue-400">Calendário de Escalas</h1>
        </div>
        <div class="flex justify-between items-center mb-2">
            <button id="toggleViewButton" class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-3 rounded-lg shadow text-sm transition-colors">
                Alternar Visualização
            </button>
            <button id="openSettingsButton" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-3 rounded-lg shadow text-sm transition-colors">
                Configurações
            </button>
        </div>

        <div id="shiftFilterButtonsContainer" class="my-4 flex flex-wrap justify-center">
            </div>
        
        <div class="flex justify-between items-center mb-4">
            <button id="prevMonth" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" /></svg>
            </button>
            <h2 id="currentMonthYear" class="text-xl font-semibold"></h2>
            <button id="nextMonth" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" /></svg>
            </button>
        </div>
        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>

        <div class="mt-6 text-center">
            <div id="selectedDayInfo" class="text-sm text-gray-600 dark:text-gray-300 mb-2 hidden"></div>
            <button id="suggestActivityButton" class="hidden bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-colors text-sm">
                ✨ Sugerir Atividades para Folga
            </button>
            <div id="activitySuggestionArea" class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg shadow hidden text-left">
                </div>
        </div>
    </div>

    <div id="settingsModal" class="modal hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-100">Configurações da Escala</h3>
                <button id="closeSettingsButton" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label for="scheduleType" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Tipo de Escala:</label>
                    <select id="scheduleType" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"></select>
                </div>
                <div>
                    <label for="referenceDate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Data de Início do Ciclo (Ala 1):</label>
                    <input type="date" id="referenceDate" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                </div>
                <div>
                    <label for="startDayOfWeek" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Começar Semana Em:</label>
                    <select id="startDayOfWeek" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white">
                        <option value="Sunday">Domingo</option>
                        <option value="Monday">Segunda-feira</option>
                    </select>
                </div>
                <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                    <h4 class="text-md font-semibold text-gray-700 dark:text-gray-300 mb-2">Configuração das Alas:</h4>
                    <div id="shiftSettingsContainer" class="space-y-3"></div>
                </div>
            </div>
            <div class="mt-8 flex justify-center">
                <button id="saveSettingsButton" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow transition-colors">
                    Salvar Configurações
                </button>
            </div>
        </div>
    </div>

    <div id="toastNotification" class="hidden fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg max-w-xs z-[100] opacity-0" role="alert">
        <span id="toastMessage"></span>
    </div>
</body>
</html>
